<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor - Manage Details</title>
    <style>
        /* Minimal required styling for a functional table editor */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #007bff;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.Range2em;
        }

        /* --- NEW/MODIFIED STYLES FOR SCROLLING AND INPUT SIZING --- */
        .table-responsive {
            overflow-x: auto; /* Enables horizontal scrolling */
            width: 100%;
            margin-bottom: 20px;
        }

        #productTable {
            width: 100%; 
            min-width: 900px; /* Ensure table minimum size for scrolling */
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #productTable th, #productTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top; /* Align content to the top */
        }
        #productTable th {
            background-color: #007bff;
            color: white;
            position: sticky;
            top: 0;
        }
        #productTable td input, #productTable td textarea {
            width: 95%;
            padding: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            /* NEW: Set a minimum width for all input/textarea */
            min-width: 100px; 
        }
        /* NEW: Specific minimum widths for wider fields */
        #productTable td input[data-field="description"], 
        #productTable td textarea[data-field="details"] {
            min-width: 200px; /* Ensure description/details are wide enough */
        }
        /* END NEW/MODIFIED STYLES */

        /* Existing Image Preview Style */
        .image-preview-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 3px;
        }

        .action-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
        }
        .action-button:hover {
            background-color: #218838;
        }
        .back-link {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        /* ADDED: Style for success status */
        .success {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <a href="studio.html" class="back-link">Back to Studio (Add Products)</a>
        <h1 id="pageTitle">Product Editor: Loading...</h1>
        <button id="saveChangesBtn" class="action-button" disabled>Save All Changes (0)</button>
    </div>

    <p id="statusMessage" class="loading">Loading products...</p>

    <div id="tableContainer" class="table-responsive">
        <table id="productTable">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Cost Price (Ksh)</th>
                    <th>Sell Price (Ksh)</th>
                    <th>Description</th>
                    <th>Details</th>
                    <th>Image Link (URL)</th>
                    <th>Image Preview</th> 
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>
    </div>

    <p style="margin-top: 20px;">
        <button id="saveChangesBtnBottom" class="action-button" disabled>Save All Changes (0)</button>
    </p>

   <script>
    // ==========================================================
    // CONFIGURATION (MUST MATCH YOUR MAIN FILE)
    // ==========================================================
    // IMPORTANT: Replace this with your actual Web App URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzqTcEcbaTAEIlPmUWzQfy5SuZgRH0z4m4XVm27lgEKo8r8NnPyFYm2mxhrLMPouNtl/exec'; 
    const CURRENCY_SYMBOL = "KES"; 
    const OWNER_BUSINESS_KEY = 'ownerBusinessName';
    const GALLERY_STORAGE_KEY = 'productLinkGallery'; // Key for localStorage

    // --- Global State ---
    let businessName = null;
    let productsData = []; // Array of product objects from the server
    let changedProducts = new Set(); // Stores the productId of products with unsaved changes
    // ---------------------------------------------------------

    // ==========================================================
    // DOM REFERENCES
    // ==========================================================
    const pageTitle = document.getElementById("pageTitle");
    const statusMessage = document.getElementById("statusMessage");
    const productTableBody = document.getElementById("productTableBody");
    const saveChangesBtnTop = document.getElementById("saveChangesBtn");
    const saveChangesBtnBottom = document.getElementById("saveChangesBtnBottom");

    // === Gallery/Add Product Form References (Assumed from user's snippet) ===
    // NOTE: These are needed to define the utility functions but may not exist on this editor page. 
    // We define the core link logic regardless.
    const driveLinkInput = document.getElementById("driveLinkInput"); // Assuming this exists in the *other* file
    const productNameInput = document.getElementById("productNameInput"); // Assuming this exists in the *other* file
    // ==========================================================

    // ==========================================================
    // UTILITY FUNCTIONS (Added/Modified for Drive/Image Logic)
    // ==========================================================

    /**
     * Reads the business name from the URL query string.
     */
    function getBusinessNameFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('business');
        return name ? decodeURIComponent(name) : null;
    }

    /**
     * Helper to remove number formatting (commas).
     */
    function unformatNumber(value) {
        if (typeof value !== 'string') return value;
        return value.replace(/,/g, ''); 
    }

    /**
     * Updates the Save buttons with the count of changes.
     */
    function updateSaveButtonCount() {
        const count = changedProducts.size;
        const text = `Save All Changes (${count})`;
        saveChangesBtnTop.textContent = text;
        saveChangesBtnBottom.textContent = text;
        saveChangesBtnTop.disabled = count === 0;
        saveChangesBtnBottom.disabled = count === 0;
    }

    /**
     * Extracts the file ID from a Google Drive URL.
     */
    function extractDriveId(url) {
        if (!url) return null;
        url = url.trim();
        // Match shared link: .../d/FILE_ID/view
        const matchId = url.match(/\/d\/(.*?)\/view/);
        if (matchId && matchId[1]) return matchId[1];
        
        // Match file manager link: ...&id=FILE_ID...
        const matchQuery = url.match(/[?&]id=([^&]+)/);
        if (matchQuery && matchQuery[1]) return matchQuery[1];

        // Return the whole thing if it looks like just an ID
        if (url.length > 20 && !url.includes('http')) return url;

        return null;
    }

    /**
     * Checks if a URL looks like a direct image link.
     */
    function isDirectImageUrl(url) {
        if (!url) return false;
        return /\.(jpe?g|png|gif|webp|svg)$/i.test(url.trim());
    }
    
    /**
     * Generates a thumbnail URL, either from Google Drive or a direct link.
     * This is the KEY function from your gallery example.
     */
    function getThumbnailUrl(link, size = 150) {
        const url = link ? link.trim() : '';

        // 1. Handle Google Drive Links
        const driveId = extractDriveId(url);
        if (driveId) {
            // Google Drive thumbnail API
            return `https://drive.google.com/thumbnail?id=${driveId}&sz=w${size}-h${size}`;
        }

        // 2. Handle Direct Image Links
        if (isDirectImageUrl(url)) {
            return url; // Use the URL directly
        }

        return null; // Invalid link
    }


    /**
     * Creates and returns the image preview element (img tag).
     * * ***MODIFIED: Uses getThumbnailUrl to ensure a correct source is used.***
     */
    function createPreviewElement(link, productName) {
        const thumbLink = getThumbnailUrl(link, 50); // Get a small thumbnail URL
        
        if (!thumbLink) {
            const span = document.createElement('span');
            span.textContent = 'Invalid Link';
            span.style.color = '#888';
            span.style.fontSize = '0.7em';
            return span;
        }

        const img = document.createElement('img');
        img.src = thumbLink;
        img.alt = `Image for ${productName || 'product'}`;
        img.className = 'image-preview-thumb';
        
        // Handle broken image links: hide the img tag and show a simple text error.
        img.onerror = function() {
            const cell = this.parentElement;
            cell.textContent = 'âŒ Broken Link'; // Simple text replacement
            cell.style.fontSize = '0.7em'; 
            cell.style.color = 'red';
            this.remove(); // Remove the broken image element
        };

        // Allow clicking to view full image (using the original link) in a new tab
        img.addEventListener('click', () => {
            if (link.trim()) {
                window.open(link.trim(), '_blank');
            }
        });
        return img;
    }


    // ==========================================================
    // DATA FETCHING AND RENDERING
    // ==========================================================

    /**
     * Fetches product data for the specific business.
     */
    async function fetchProductsForBusiness(business, isReload = false) {
        if (!isReload) {
            statusMessage.textContent = `Fetching products for: ${business}...`;
            statusMessage.className = 'loading';
            statusMessage.style.display = 'block';
        } else {
             // Show subtle message during post-save reload
             statusMessage.textContent = `Refreshing data...`;
             statusMessage.className = 'loading';
             statusMessage.style.display = 'block';
        }
        productTableBody.innerHTML = ''; // Clear table while loading


        try {
            const payload = {
                action: "getProductsByBusiness",
                businessName: business
            };
            
            const res = await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "cors",
                headers: {"Content-Type": "text/plain"}, 
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            
            if (json && Array.isArray(json.rows)) {
                // Store products globally
              productsData = json.rows.reverse(); // NEWEST FIRST
renderEditableTable(productsData);


                
                if (productsData.length === 0) {
                    statusMessage.textContent = 'No products found for this business.';
                    statusMessage.className = '';
                } else {
                    if (isReload) {
                         // Show success status temporarily after a save & refresh
                        statusMessage.textContent = 'âœ… Save complete. Data refreshed.';
                        statusMessage.className = 'success';
                        setTimeout(() => statusMessage.style.display = 'none', 3000); // Hide after 3 seconds
                    } else {
                        statusMessage.style.display = 'none'; // Hide if first load is successful
                    }
                }
            } else {
                statusMessage.textContent = `Error: Could not retrieve products for "${business}". Message: ${json.message || 'Unknown error.'}`;
                statusMessage.className = 'error';
                statusMessage.style.display = 'block';
            }
        } catch (err) {
            console.error("Fetch error:", err);
            statusMessage.textContent = "Network Error: Failed to connect to the backend.";
            statusMessage.className = 'error';
            statusMessage.style.display = 'block';
        }
    }

    /**
     * Renders the products in an editable table, including the image preview.
     */
    function renderEditableTable(products) {
        productTableBody.innerHTML = '';
        
        // Colspan needs to be 9 now (8 original columns + 1 Image Preview column)
        const totalColumns = 9; 
        if (products.length === 0) {
            productTableBody.innerHTML = `<tr><td colspan="${totalColumns}" style="text-align:center;">No products found for this business.</td></tr>`;
            return;
        }

        products.forEach(product => {
            const row = productTableBody.insertRow();
            row.dataset.id = product.id; // CRITICAL: Store the unique ID for reference

            const fields = [
                { key: 'category', type: 'text', value: product.category },
                { key: 'name', type: 'text', value: product.name },
                { key: 'quantity', type: 'number', value: product.quantity, min: 0 },
                { key: 'buy', type: 'number', value: product.buy, step: 0.01, min: 0 },
                { key: 'sell', type: 'number', value: product.sell, step: 0.01, min: 0 },
                { key: 'description', type: 'text', value: product.description },
                { key: 'details', type: 'textarea', value: product.details }, // Use textarea for multi-line
                { key: 'driveLink', type: 'url', value: product.driveLink }
            ];

            fields.forEach(field => {
                const cell = row.insertCell();
                let inputElement;

                if (field.type === 'textarea') {
                    inputElement = document.createElement('textarea');
                    inputElement.rows = 2;
                    inputElement.textContent = field.value || '';
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = field.type;
                    inputElement.value = field.value || '';
                    if (field.min !== undefined) inputElement.min = field.min;
                    if (field.step !== undefined) inputElement.step = field.step;
                }

                inputElement.dataset.field = field.key;
                // Use toString().trim() for consistent comparison later
                inputElement.dataset.original = (field.value || '').toString().trim(); 
                inputElement.addEventListener('input', handleInputChange);
                
                cell.appendChild(inputElement);
            });
            
            // Image Preview Cell (9th column)
            const previewCell = row.insertCell();
            if (product.driveLink && product.driveLink.trim()) {
                // ***MODIFIED HERE: Use the link creation function***
                previewCell.appendChild(createPreviewElement(product.driveLink, product.name));
            } else {
                previewCell.textContent = 'No image';
            }
        });
    }

    /**
     * Handles changes in table inputs and updates the change tracker.
     */
    function handleInputChange(event) {
        const input = event.target;
        const row = input.closest('tr');
        const productId = row.dataset.id;
        const fieldName = input.dataset.field;
        
        // Normalize values for comparison
        const originalValue = input.dataset.original;
        const currentValue = input.value.trim();
        
        // Normalize numbers for comparison (e.g., '10.0' vs 10)
        const isNumberField = ['quantity', 'buy', 'sell'].includes(fieldName);

        const normalizedOriginal = isNumberField ? parseFloat(originalValue) : originalValue;
        const normalizedCurrent = isNumberField ? parseFloat(unformatNumber(currentValue)) : currentValue;

        let isChanged = String(normalizedCurrent) !== String(normalizedOriginal);

        // Dynamic Image Preview Update
        if (fieldName === 'driveLink') {
            const previewCell = row.cells[8]; // Image Preview is the 9th cell (index 8)
            previewCell.innerHTML = ''; 
            if (currentValue) {
                // ***MODIFIED HERE: Use the link creation function for dynamic update***
                previewCell.appendChild(createPreviewElement(currentValue, 'product'));
            } else {
                previewCell.textContent = 'No image';
            }
        }

        if (isChanged) {
            // Mark row as changed
            row.style.backgroundColor = '#fff3cd'; // Light yellow to indicate unsaved changes
            changedProducts.add(productId);
        } else {
            // Check if the whole row has been reverted to original values
            let reverted = true;
            row.querySelectorAll('input, textarea').forEach(el => {
                const elField = el.dataset.field;
                const elOriginal = (el.dataset.original || '').toString().trim();
                const elCurrent = el.value.trim();
                
                const elIsNumberField = ['quantity', 'buy', 'sell'].includes(elField);

                const elNormalizedOriginal = elIsNumberField ? parseFloat(elOriginal) : elOriginal;
                const elNormalizedCurrent = elIsNumberField ? parseFloat(unformatNumber(elCurrent)) : elCurrent;

                if (String(elNormalizedCurrent) !== String(elNormalizedOriginal)) {
                    reverted = false;
                }
            });

            if (reverted) {
                row.style.backgroundColor = '';
                changedProducts.delete(productId);
            }
        }
        updateSaveButtonCount();
    }

    // ==========================================================
    // SAVE FUNCTIONALITY
    // ==========================================================

    /**
     * Gathers all changed products and submits a bulk update request.
     */
    async function saveAllChanges() {
        if (changedProducts.size === 0) {
            // Status message for no changes (not an error, so no alert needed)
            statusMessage.textContent = "No changes detected.";
            statusMessage.className = '';
            statusMessage.style.display = 'block';
            setTimeout(() => statusMessage.style.display = 'none', 3000);
            return;
        }

        saveChangesBtnTop.disabled = true;
        saveChangesBtnBottom.disabled = true;
        statusMessage.style.display = 'block';
        statusMessage.className = 'loading';
        statusMessage.textContent = `Saving ${changedProducts.size} changes... Please wait.`;

        const updates = [];
        
        changedProducts.forEach(productId => {
            const row = productTableBody.querySelector(`[data-id="${productId}"]`);
            if (row) {
                const updatedProduct = {
                    id: productId, // CRITICAL: Unique ID
                    businessName: businessName // Passed for security/scoping on backend
                };

                // Loop through all inputs/textareas to find the current values
                row.querySelectorAll('input, textarea').forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value; 

                    // Handle numerical fields (convert to number/float if needed)
                    if (['quantity', 'buy', 'sell'].includes(field)) {
                        value = unformatNumber(value);
                        // Use default 0 if parsing fails (to avoid null/NaN issues on backend)
                        updatedProduct[field] = (field === 'quantity') ? parseInt(value) || 0 : parseFloat(value) || 0.0;
                    } else {
                        updatedProduct[field] = value.trim();
                    }
                });

                updates.push(updatedProduct);
            }
        });

        const payload = {
            action: "bulkUpdateProducts",
            updates: updates 
        };

        try {
            const res = await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "cors",
                headers: {"Content-Type": "text/plain"}, 
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            
            if (json && json.result === "success") {
                
                // Clear change tracking and re-fetch data 
                changedProducts.clear();
                updateSaveButtonCount();
                await fetchProductsForBusiness(businessName, true); // True indicates a post-save reload
                
            } else {
                statusMessage.textContent = `âŒ Failed to save updates: ${json && json.message ? json.message : 'Unknown server error.'}`;
                statusMessage.className = 'error';
                statusMessage.style.display = 'block';
            }
        } catch (err) {
            console.error("Bulk save error:", err);
            statusMessage.textContent = "âŒ Network Error: An error occurred during the bulk save process.";
            statusMessage.className = 'error';
            statusMessage.style.display = 'block';
        } finally {
            if (changedProducts.size > 0) {
                saveChangesBtnTop.disabled = false;
                saveChangesBtnBottom.disabled = false;
            }
        }
    }

    // ==========================================================
    // INITIALIZATION
    // ==========================================================

    function initEditPage() {
        // 1. Get business name from URL
        businessName = getBusinessNameFromUrl();
        const localOwner = localStorage.getItem(OWNER_BUSINESS_KEY);
        
        // 2. Access Control and Setup
        if (!businessName || businessName !== localOwner) {
            pageTitle.textContent = "Access Denied ðŸ”’";
            statusMessage.className = 'error';
            if (!localOwner) {
                statusMessage.textContent = "Error: This device is not registered to a business. Please register on the studio page first.";
            } else {
                statusMessage.textContent = `Error: You do not have permission to edit products for business "${businessName || 'Unknown'}". This device is registered to "${localOwner}".`;
            }
            statusMessage.style.display = 'block';
            return;
        }

        // Set page title
        pageTitle.textContent = `Product Editor: ${businessName}`;
        
        // 3. Fetch Data
        fetchProductsForBusiness(businessName);
        
        // 4. Attach save event listeners
        saveChangesBtnTop.addEventListener('click', saveAllChanges);
        saveChangesBtnBottom.addEventListener('click', saveAllChanges);
        updateSaveButtonCount(); // Initialize button state
    }

    // Run initialization when the page loads
    document.addEventListener('DOMContentLoaded', initEditPage);
</script>
</body>
</html>