<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#3b6dc6" />
    <title>My Studio - Smart Inventory</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#3b6dc6" />
    <link rel="apple-touch-icon" href="inventory192.png" />
</head>
<body>

    <main class="page">
        <header class="admin-header">
            <h1 id="studioTitle">My Studio</h1>
            <button onclick="window.location.href='index.html'" class="btn-black">
                Home (Public View)
            </button>
            <button id="goToEditPageButton" class="btn-primary" style="margin: 20px 0; padding: 10px 20px; font-size: 16px;">
     Pro Editor
</button>
        </header>

        <!-- Toggle Form Button -->
        <button id="toggleFormBtn" class="btn-toggle">Toggle Input Form (Show)</button>

        <!-- Hidden filter (no longer needed) -->
        <div class="filter-bar-container" style="display: none;">
            <label for="businessFilterInput">
                <span class="icon">Search</span> Filter Products by Business Name:
            </label>
            <input type="text" id="businessFilterInput" placeholder="Your Business Name" class="text-input">
        </div>

        <section id="productsContainer" class="products-area">
            <div class="hint">Your products will appear here...</div>
        </section>

        <!-- Add Product Form (Hidden by default) -->
        <div id="inputContainer" style="display: none;">
            <section class="product-panel add-panel">
                
                <div class="form-row">
                    <div class="label-black">BUSINESS NAME</div>
                    <input id="businessName" class="text-input" type="text" readonly 
                           style="background:#f5f5f5; color:#333; font-weight:bold;" />
                </div>
                
                <div class="form-row">
                    <div class="label-black">CATEGORY</div>
                    <input id="businessCategory" class="text-input" type="text" placeholder="e.g., Clothing, Electronics, Food" />
                </div>

                <div class="form-row">
                    <div class="label-black">PRODUCT NAME</div>
                    <input id="productName" class="text-input" type="text" placeholder="Product name appears here" />
                </div>

                <div class="form-row">
                    <div class="label-black">QUANTITY</div>
                    <input id="productQuantity" class="text-input" type="text" 
                           placeholder="Number of products" data-numeric="true" />
                </div>

                <div class="form-row">
                    <div class="label-black">BUYING PRICE</div>
                    <input id="productBuy" class="text-input" type="text" 
                           placeholder="Buying price" data-numeric="true" />
                </div>

                <div class="form-row">
                    <div class="label-black">SELLING PRICE</div>
                    <input id="productSell" class="text-input" type="text" 
                           placeholder="Selling price" data-numeric="true" />
                </div>

                <label for="productDescription">Description:</label>
                <textarea id="productDescription" placeholder="A short, catchy description..."></textarea>

                <label for="productDetails">Details / Specs:</label>
                <textarea id="productDetails" placeholder="Detailed specs, features, or ingredients..."></textarea>

                <div class="thumb-and-link">
                    <div id="newThumb" class="thumb-preview small">Thumbnail appears</div>
                    <div class="link-column">
                        <input id="driveLink" class="text-input" type="text" placeholder="Paste Google Drive Link" />
                        <button id="previewBtn" class="btn-black small">Preview</button>
                        <button id="saveLinkBtn" class="btn-black small">Save Link</button>
                    </div>
                </div>

                <div class="add-row">
                    <button id="openGalleryBtn" class="btn-black big">Open Link Gallery</button>
                    <button id="addProductBtn" class="btn-black big">Add Product</button>
                </div>
            </section>
        </div>

        <!-- Link Gallery Dialog -->
        <dialog id="linkGalleryDialog">
            <div class="gallery-header">
                <h2>Link Gallery</h2>
                <button id="closeGalleryBtn" class="btn-black small">Close</button>
            </div>
            <section id="galleryContainer" class="products-area"></section>
        </dialog>

        <!-- Update Stock Dialog -->
        <dialog id="updateDialog" class="modal">
            <div class="modal-body">
                <button id="closeUpdateDialogBtn" class="close-btn">X</button> 
                <p class="product-title">Product: <strong id="updateProductName"></strong></p>
                
                <div class="input-group">
                    <label for="sellQuantity">Units Sold (Decrease Stock):</label>
                    <input type="text" id="sellQuantity" value="0" placeholder="Enter quantity sold"
                           class="input-field" data-numeric="true">
                </div>
                
                <div class="input-group">
                    <label for="restockQuantity">Units Restocked (Increase Stock):</label>
                    <input type="text" id="restockQuantity" value="0" placeholder="Enter quantity restocked"
                           class="input-field" data-numeric="true">
                </div>
                
                <button id="executeUpdateButton" class="btn btn-primary">
                    Execute Stock Update
                </button>
            </div>
        </dialog>
    </main>

    <!-- SECURITY + OWNER AUTO-FILL SCRIPT (MUST BE FIRST) -->
   <script>
    // === STUDIO ACCESS CONTROL & BUSINESS NAME SETUP ===
    // Try to get business name from sessionStorage first (set when entering from index.html)
    let ownerBusinessName = sessionStorage.getItem('ownerStudioAccess');

    // Fallback: if user refreshed the page, try localStorage (set below as backup)
    if (!ownerBusinessName) {
        ownerBusinessName = localStorage.getItem('ownerBusinessName');
    }

    // If still no business name â†’ block access
    if (!ownerBusinessName) {
        alert("Access denied. Please enter Studio from the main gallery.");
        window.location.href = "index.html";
        // Note: the rest of the script won't run
    }

    // === EXPOSE BUSINESS NAME TO script.js (critical!) ===
    window.BUSINESS_NAME = ownerBusinessName.trim();

    // === ALSO SAVE TO localStorage SO IT SURVIVES REFRESH ===
    localStorage.setItem('ownerBusinessName', ownerBusinessName.trim());

    // === DOM READY: Update title and form ===
    document.addEventListener('DOMContentLoaded', () => {
        document.title = `${ownerBusinessName}'s Studio`;
        document.getElementById('studioTitle').textContent = `${ownerBusinessName}'s Studio`;

        const businessInput = document.getElementById('businessName');
        if (businessInput) {
            businessInput.value = ownerBusinessName;
            businessInput.placeholder = ownerBusinessName;
        }

        // Clean up session token (one-time use)
        sessionStorage.removeItem('ownerStudioAccess');
    });
</script>

    <!-- Number Formatting & Form Toggle -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const numericInputs = document.querySelectorAll('input[data-numeric="true"]');

            const unformatNumber = (value) => value.replace(/,/g, '');
            const formatNumber = (value) => {
                const raw = unformatNumber(value);
                let [integerPart, decimalPart] = raw.split('.');
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return decimalPart !== undefined ? `${integerPart}.${decimalPart}` : integerPart;
            };

            numericInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const cursor = e.target.selectionStart;
                    const oldLen = e.target.value.length;
                    const formatted = formatNumber(e.target.value);
                    e.target.value = formatted;
                    const newLen = formatted.length;
                    e.target.setSelectionRange(cursor + (newLen - oldLen), cursor + (newLen - oldLen));
                });
                input.addEventListener('blur', (e) => {
                    e.target.value = formatNumber(e.target.value);
                });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const toggleBtn = document.getElementById('toggleFormBtn');
            const inputContainer = document.getElementById('inputContainer');
            const content = inputContainer.querySelector('.product-panel.add-panel');

            inputContainer.style.maxHeight = '0';
            inputContainer.style.opacity = '0';
            inputContainer.style.overflow = 'hidden';
            inputContainer.style.transition = 'max-height 0.6s ease, opacity 0.4s ease';
            inputContainer.style.display = 'block';

            toggleBtn.addEventListener('click', () => {
                if (inputContainer.style.maxHeight === '0px' || !inputContainer.style.maxHeight) {
                    inputContainer.style.maxHeight = (content.scrollHeight + 60) + 'px';
                    inputContainer.style.opacity = '1';
                    toggleBtn.textContent = 'Toggle Input Form (Hide)';
                } else {
                    inputContainer.style.maxHeight = '0';
                    inputContainer.style.opacity = '0';
                    toggleBtn.textContent = 'Toggle Input Form (Show)';
                }
            });
        });
    </script>

    <script src="script.js" defer></script>
</body>
</html>