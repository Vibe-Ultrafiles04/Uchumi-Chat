<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#3b6dc6" />
    <title>My Studio - Smart Inventory</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="inventory192.png" />
    <style>
        /* Smooth transitions for form toggle */
        #inputContainer {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.6s ease, opacity 0.4s ease;
            display: block;
        }
        .or-divider {
            text-align: center; 
            font-size: 11px; 
            color: #888; 
            margin: 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .thumb-preview {
            cursor: pointer;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        .thumb-preview:hover {
            border-color: #3b6dc6;
            background: #f0f4ff;
        }
    </style>
</head>
<body>

    <main class="page">
        <header class="admin-header">
            <h1 id="studioTitle">My Studio</h1>
            <div class="header-btns">
                <button onclick="window.location.href='./index.html'" class="btn-black">
                    Home (Public View)
                </button>
                <button id="goToEditPageButton" class="btn-primary">
                    Pro Editor
                </button>
            </div>
        </header>

        <!-- Toggle Form Button -->
        <button id="toggleFormBtn" class="btn-toggle">Toggle Input Form (Show)</button>

        <!-- Hidden filter (no longer needed) -->
        <div class="filter-bar-container" style="display: none;">
            <label for="businessFilterInput">
                <span class="icon">Search</span> Filter Products by Business Name:
            </label>
            <input type="text" id="businessFilterInput" placeholder="Your Business Name" class="text-input">
        </div>

        <!-- Add Product Form (Hidden by default via inline JS below) -->
        <div id="inputContainer">
            <section class="product-panel add-panel">
                
                <div class="form-row">
                    <div class="label-black">BUSINESS NAME</div>
                    <input id="businessName" class="text-input" type="text" readonly 
                           style="background:#f5f5f5; color:#333; font-weight:bold;" />
                </div>
                
                <div class="form-row">
                    <div class="label-black">CATEGORY</div>
                    <input id="businessCategory" class="text-input" type="text" placeholder="e.g., Clothing, Electronics, Food" />
                </div>

                <div class="form-row">
                    <div class="label-black">PRODUCT NAME</div>
                    <input id="productName" class="text-input" type="text" placeholder="Product name appears here" />
                </div>

                <div class="form-row">
                    <div class="label-black">QUANTITY</div>
                    <input id="productQuantity" class="text-input" type="text" 
                           placeholder="Number of products" data-numeric="true" />
                </div>

                <div class="form-row">
                    <div class="label-black">BUYING PRICE</div>
                    <input id="productBuy" class="text-input" type="text" 
                           placeholder="Buying price" data-numeric="true" />
                </div>

                <div class="form-row">
                    <div class="label-black">SELLING PRICE</div>
                    <input id="productSell" class="text-input" type="text" 
                           placeholder="Selling price" data-numeric="true" />
                </div>

                <label for="productDescription">Description:</label>
                <textarea id="productDescription" placeholder="A short, catchy description..."></textarea>

                <label for="productDetails">Details / Specs:</label>
                <textarea id="productDetails" placeholder="Detailed specs, features, or ingredients..."></textarea>

                <div class="thumb-and-link">
                    <!-- Thumbnail preview also triggers file upload -->
                    <div id="newThumb" class="thumb-preview small" onclick="document.getElementById('imageFileInput').click()">
                        Tap to Upload Image
                    </div>
                    
                    <div class="link-column">
                        <!-- Direct Upload Button -->
                        <button type="button" class="btn-black small" onclick="document.getElementById('imageFileInput').click()">
                            ðŸ“¸ Upload from device
                        </button>
                        <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                        
                        <div class="or-divider">â€” OR â€”</div>
                        
                        <input id="driveLink" class="text-input" type="text" placeholder="Paste Google Drive Link" />
                        <div style="display: flex; gap: 5px;">
                            <button id="previewBtn" class="btn-black small" style="flex:1">Preview</button>
                            <button id="saveLinkBtn" class="btn-black small" style="flex:1">Save Link</button>
                        </div>
                    </div>
                </div>

                <div class="add-row">
                    <button id="openGalleryBtn" class="btn-black big">Open Link Gallery</button>
                    <button id="addProductBtn" class="btn-black big">Add Product</button>
                </div>
            </section>
        </div>

        <section id="productsContainer" class="products-area">
            <div class="hint">Your products will appear here...</div>
        </section>

        <!-- Link Gallery Dialog -->
        <dialog id="linkGalleryDialog">
            <div class="gallery-header">
                <h2>Link Gallery</h2>
                <button id="closeGalleryBtn" class="btn-black small">Close</button>
            </div>
            <section id="galleryContainer" class="products-area"></section>
        </dialog>

        <!-- Update Stock Dialog -->
        <dialog id="updateDialog" class="modal">
            <div class="modal-body">
                <button id="closeUpdateDialogBtn" class="close-btn">X</button> 
                <p class="product-title">Product: <strong id="updateProductName"></strong></p>
                
                <div class="input-group">
                    <label for="sellQuantity">Units Sold (Decrease):</label>
                    <input type="text" id="sellQuantity" value="0" class="input-field" data-numeric="true">
                </div>
                
                <div class="input-group">
                    <label for="restockQuantity">Units Restocked (Increase):</label>
                    <input type="text" id="restockQuantity" value="0" class="input-field" data-numeric="true">
                </div>
                
                <button id="executeUpdateButton" class="btn-primary">
                    Execute Stock Update
                </button>
            </div>
        </dialog>
    </main>

    <script>
      // Service Worker Registration - Fixed for Blob/Preview environment
      if ('serviceWorker' in navigator && window.location.protocol.startsWith('http')) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(err => {
            console.warn("ServiceWorker registration skipped or failed:", err.message);
          });
        });
      }
    </script>

    <!-- SECURITY + OWNER AUTO-FILL SCRIPT -->
    <script>
        let ownerBusinessName = sessionStorage.getItem('ownerStudioAccess');
        if (!ownerBusinessName) {
            ownerBusinessName = localStorage.getItem('ownerBusinessName');
        }

        if (!ownerBusinessName) {
            alert("Access denied. Please enter Studio from the main gallery.");
            window.location.href = "./index.html";
        } else {
            window.BUSINESS_NAME = ownerBusinessName.trim();
            localStorage.setItem('ownerBusinessName', ownerBusinessName.trim());

            document.addEventListener('DOMContentLoaded', () => {
                document.title = `${ownerBusinessName}'s Studio`;
                const studioTitle = document.getElementById('studioTitle');
                if (studioTitle) studioTitle.textContent = `${ownerBusinessName}'s Studio`;

                const businessInput = document.getElementById('businessName');
                if (businessInput) {
                    businessInput.value = ownerBusinessName;
                }
                sessionStorage.removeItem('ownerStudioAccess');
            });
        }
    </script>

    <!-- UI Interaction Script (Number Formatting & Form Toggle) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Numeric formatting
            const numericInputs = document.querySelectorAll('input[data-numeric="true"]');
            const unformat = (v) => v.replace(/,/g, '');
            const format = (v) => {
                const raw = unformat(v);
                let [int, dec] = raw.split('.');
                int = int.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return dec !== undefined ? `${int}.${dec}` : int;
            };

            numericInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const cursor = e.target.selectionStart;
                    const oldLen = e.target.value.length;
                    const formatted = format(e.target.value);
                    e.target.value = formatted;
                    const newLen = formatted.length;
                    e.target.setSelectionRange(cursor + (newLen - oldLen), cursor + (newLen - oldLen));
                });
            });

            // Form Toggle Logic
            const toggleBtn = document.getElementById('toggleFormBtn');
            const inputContainer = document.getElementById('inputContainer');
            const content = inputContainer ? inputContainer.querySelector('.product-panel.add-panel') : null;

            if (toggleBtn && inputContainer && content) {
                toggleBtn.addEventListener('click', () => {
                    if (inputContainer.style.maxHeight === '0px' || !inputContainer.style.maxHeight || inputContainer.style.maxHeight === '0') {
                        inputContainer.style.maxHeight = (content.scrollHeight + 100) + 'px';
                        inputContainer.style.opacity = '1';
                        toggleBtn.textContent = 'Toggle Input Form (Hide)';
                    } else {
                        inputContainer.style.maxHeight = '0';
                        inputContainer.style.opacity = '0';
                        toggleBtn.textContent = 'Toggle Input Form (Show)';
                    }
                });
            }

            // Handle Image Upload File Change (UI Only)
            const fileInput = document.getElementById('imageFileInput');
            const thumbPreview = document.getElementById('newThumb');
            if (fileInput && thumbPreview) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            thumbPreview.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>

    <script src="script.js" defer></script>
</body>
</html>