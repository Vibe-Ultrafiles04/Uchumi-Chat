<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Products | Kona-Mart</title>

<link rel="stylesheet" href="style.css">



<meta property="og:title" content="Kona Mart| Discover Local Business Products">

<meta property="og:url" content="https://vibe-ultrafiles04.github.io/Kona-Mart/business.html">

<meta property="og:description" content="Discover my products and services instantly on Kona Mart.">


<meta property="og:image" content="https://raw.githubusercontent.com/Vibe-Ultrafiles04/Uchumi-Chat/main/Kona100.png">


<meta property="og:type" content="website">



<meta name="twitter:card" content="summary_large_image">

<meta name="twitter:image" content="https://raw.githubusercontent.com/Vibe-Ultrafiles04/Uchumi-Chat/main/Kona100.png">

    <style>
        body { 
            margin: 0; 
            padding: 0 0 80px; 
            background: #f9f9f9; 
            font-family: "Segoe UI", Roboto, Arial, sans-serif; 
            overflow-x: hidden;
        }

        /* ====== SMOOTH PAGE TRANSITIONS ====== */
        body {
            animation: slideInFromRight 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        body.page-exit {
            animation: slideOutToLeft 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to   { transform: translateX(-100%); opacity: 0; }
        }

        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: #000; }

        .business-header {
            text-align: center;
            padding: 80px 20px 40px;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('') center/cover no-repeat;
            color: white;
            margin-bottom: 30px;
        }
        .business-header h1 { font-size: 2.8rem; margin: 0 0 10px 0; }
        .business-header .categories { font-size: 1.2rem; opacity: 0.9; }

        .business-description {
            font-size: 1.15rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 20px auto 0;
            opacity: 0.95;
            font-weight: 300;
            padding: 0 20px;
        }
        @media (max-width: 768px) {
            .business-description { font-size: 1rem; padding: 0 15px; }
        }

        .subscribe-wrapper {
            margin: 25px auto 0;
            text-align: center;
            max-width: 800px;
        }
        #subscribeBtn {
            padding: 14px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }
        #subscribeBtn.follow { background: #4285f4; color: white; }
        #subscribeBtn.follow:hover { background: #3367d6; }
        #subscribeBtn.unfollow { background: #eee; color: #333; }
        #subscribeBtn.unfollow:hover { background: #ddd; }
        #subscribeBtn:disabled { opacity: 0.6; cursor: not-allowed; }

        #subscriberCount {
            margin-top: 10px;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        /* PROMOTIONAL VIDEO SECTION */
        .video-section {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s ease-out forwards;
        }
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: #000;
            cursor: pointer;
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .video-info {
            text-align: center;
            margin-top: 12px;
            color: #555;
            font-size: 0.95rem;
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        #businessProductsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
            margin: 0 auto;
            max-width: 1400px;
        }
    </style>
</head>
<body>

    <button class="back-btn" onclick="goBackSmooth()">Back</button>

    <div class="business-header">
        <h1 id="businessName">Loading...</h1>
        <div class="categories" id="businessCategories"></div>
        <p class="business-description" id="businessDescription">Loading description...</p>

        <div class="subscribe-wrapper">
            <button id="subscribeBtn" class="follow" disabled>Loading...</button>
            <div id="subscriberCount">— followers</div>
        </div>

        <div class="share-wrapper" id="shareWrapper" style="margin-top: 30px; padding: 0 20px;">
            <p id="shareLabel" style="font-size: 1rem; margin-bottom: 10px; opacity: 0.9;">
                Share this business page:
            </p>
            <div style="display: flex; gap: 10px; max-width: 600px; margin: auto;">
                <input type="text" id="shareLinkInput" readonly 
                       style="flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 0.95rem; background: #fff;">
                <button id="copyShareLinkBtn" 
                        style="padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Copy Link
                </button>
            </div>
        </div>
    </div>

    <!-- PROMOTIONAL VIDEO (appears only if set) -->
    <div class="video-section" id="videoSection" style="display:none;">
        <div class="video-wrapper" id="videoWrapper">
            <iframe id="promoVideo" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe>
        </div>
        <div class="video-info">
            <span id="videoViews">0 views</span>
        </div>
    </div>

    <div id="businessProductsContainer">
        <div class="hint">Loading products...</div>
    </div>

    <div id="productsContainer" style="display:none;"></div>

    <script>
        window.IS_ADMIN_VIEW = false;
    </script>
    <script src="index.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqTcEcbaTAEIlPmUWzQfy5SuZgRH0z4m4XVm27lgEKo8r8NnPyFYm2mxhrLMPouNtl/exec";

    function getMyDeviceId() {
        let id = localStorage.getItem('myDeviceId');
        if (!id) {
            id = 'guest_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            localStorage.setItem('myDeviceId', id);
        }
        return id;
    }
    const MY_DEVICE_ID = getMyDeviceId();

    let businessOwnerId = null;
    let isFollowing = false;
    let currentVideoViews = 0;
    

    const subscribeBtn = document.getElementById('subscribeBtn');
    const subscriberCountEl = document.getElementById('subscriberCount');
    const videoSection = document.getElementById('videoSection');
    const videoWrapper = document.getElementById('videoWrapper');
    const promoVideo = document.getElementById('promoVideo');
    const videoViewsEl = document.getElementById('videoViews');
    const businessDescriptionEl = document.getElementById('businessDescription'); 

    function goBackSmooth() {
        document.body.classList.add('page-exit');
        setTimeout(() => window.history.back(), 100);
    }

    const params = new URLSearchParams(location.search);
    const targetBusiness = decodeURIComponent(params.get('name') || '').trim();

    if (!targetBusiness) {
        document.getElementById('businessName').textContent = 'Invalid Link';
        document.getElementById('businessProductsContainer').innerHTML = '<div class="hint">No business specified</div>';
    } else {
        document.getElementById('businessName').textContent = targetBusiness;
    }

    // Extract Google Drive file ID from share link
    function extractDriveId(url) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
    }

    // Format view count nicely
    function formatViews(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M views';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K views';
        return num + (num === 1 ? ' view' : ' views');
    }

    // Load video (no view increment here)
    async function loadPromotionalVideo(profileData) {
        if (!profileData?.videoLink) {
            videoSection.style.display = 'none';
            return;
        }

        const driveId = extractDriveId(profileData.videoLink);
        if (!driveId) {
            videoSection.style.display = 'none';
            return;
        }
        

        promoVideo.src = `https://drive.google.com/file/d/${driveId}/preview`;
        currentVideoViews = profileData.videoViews || 0;
        videoViewsEl.textContent = formatViews(currentVideoViews);
        videoSection.style.display = 'block';
    }

    // Increment view only on first click per device
    async function countVideoView() {
        if (!businessOwnerId || MY_DEVICE_ID === businessOwnerId) return;

        // Check if video section is visible before trying to count the view.
        if (videoSection.style.display === 'none') return;
        
        const viewedKey = `videoViewed_${businessOwnerId}`;
        if (localStorage.getItem(viewedKey)) return;

        // Mark as viewed immediately to prevent double-counting on the same device/session
        localStorage.setItem(viewedKey, 'true');

        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",                    // Required for Google Apps Script
                headers: { "Content-Type": "text/plain" },  // Helps avoid CORS preflight
                body: JSON.stringify({
                    action: "incrementVideoView",
                    businessOwnerId: businessOwnerId,
                    viewerDeviceId: MY_DEVICE_ID     
                })
            });

            // Note: With no-cors, we can't read the response body
            // But the server still processed it, so we can safely increment locally
            currentVideoViews += 1;
            videoViewsEl.textContent = formatViews(currentVideoViews);

        } catch (err) {
            // Even if network fails, give user visual feedback (view was likely still counted server-side)
            currentVideoViews += 1;
            videoViewsEl.textContent = formatViews(currentVideoViews);
        }
    }
    
    // NEW HELPER FUNCTION
    async function findOwnerIdByBusinessName(businessName) {
        try {
            const resp = await fetch(`${SCRIPT_URL}?action=findOwnerByName&name=${encodeURIComponent(businessName)}`);
            const json = await resp.json();
            if (json.result === "success" && json.deviceId) {
                return json.deviceId;
            }
            return null;
        } catch (e) {
            console.error("Error finding owner by name:", e);
            return null;
        }
    }

    /**
     * A. Refactored determineOwnerId:
     * NOW ONLY RESPONSIBLE FOR FINDING THE businessOwnerId.
     * REMOVED: All product fetching logic.
     */
    async function determineOwnerId() {
        let ownerId = null;

        // 1. Search BusinessProfiles sheet by business name
        ownerId = await findOwnerIdByBusinessName(targetBusiness);
        if (ownerId) {
            console.log(`Owner found by name: ${ownerId}`);
            return ownerId;
        }

        // 2. As last resort, check if the current device (MY_DEVICE_ID) owns this business name
        if (!ownerId) {
            console.log("Owner not found by name. Checking if current device is owner...");
            try {
                const myProfileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${MY_DEVICE_ID}`);
                const myProfileJson = await myProfileResp.json();
                
                const myBusinessName = myProfileJson.data?.businessName?.trim();
                if (myProfileJson.result === "success" && myBusinessName === targetBusiness) {
                    console.log(`Current device (${MY_DEVICE_ID}) owns the business name.`);
                    return MY_DEVICE_ID;
                }
            } catch (e) {
                console.warn("Error checking current device ownership:", e);
            }
        }

        return ownerId; // Will be null if all steps fail
    }

    // NEW FUNCTION TO LOAD PROFILE (Description, Video, Subscribers)
    async function loadProfileData(ownerId) {
        if (!ownerId) {
            businessDescriptionEl.textContent = "No owner ID found for this business.";
            subscribeBtn.disabled = true;
            subscribeBtn.textContent = "Unavailable";
            return;
        }

        businessOwnerId = ownerId; // Set the global ID

        if (MY_DEVICE_ID === businessOwnerId) {
            subscribeBtn.textContent = "This is your business";
            subscribeBtn.disabled = true;
            subscribeBtn.className = "";
            window.IS_ADMIN_VIEW = true; // NEW: Set admin view flag
        } else {
            window.IS_ADMIN_VIEW = false;
        }

        // 1. Load Business Profile
        try {
            const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`);
            const profileJson = await profileResp.json();

            if (profileJson.result === "success" && profileJson.data) {
                const desc = profileJson.data.businessDescription?.trim();
                businessDescriptionEl.textContent = desc || "This business hasn’t added a description yet.";
                subscriberCountEl.textContent = `${profileJson.data.subscribers || 0} follower${profileJson.data.subscribers !== 1 ? 's' : ''}`;

                loadPromotionalVideo(profileJson.data);
                
                // Check if backend count is 0 and remove local storage key
                if (profileJson.data.videoLink && profileJson.data.videoViews === 0) {
                    const viewedKey = `videoViewed_${businessOwnerId}`;
                    localStorage.removeItem(viewedKey);
                }
                
                // Automatically count video view on successful load
                // NOTE: The previous logic of calling countVideoView was kept here
                if (profileJson.data.videoLink) {
                    countVideoView();
                }

            } else {
                businessDescriptionEl.textContent = "Business profile not found or data error.";
                subscribeBtn.disabled = true;
                subscribeBtn.textContent = "Unavailable";
            }

        } catch (e) {
            console.error("Error loading profile:", e);
            businessDescriptionEl.textContent = "Failed to load business profile info.";
            subscribeBtn.disabled = true;
            subscribeBtn.textContent = "Unavailable";
            return;
        }

        // 2. Load Subscription Status
        try {
            const myResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${MY_DEVICE_ID}`);
            const myJson = await myResp.json();
            isFollowing = myJson.result === "success" && myJson.data?.subscribedTo?.includes(businessOwnerId);
            updateSubscribeButton();
        } catch (e) {
            console.error("Error loading subscription status:", e);
            updateSubscribeButton(); // Still update button, just keep disabled if no ownerId
        }
    }


    /**
     * B. Refactored fetchAndRenderProducts:
     * RENAMED: from fetchAndRenderProducts to loadAndDisplayProducts.
     * ACCEPTS: ownerId as argument.
     * USES: ownerId (deviceId) to fetch products.
     */
    async function loadAndDisplayProducts(ownerId) {
        const container = document.getElementById('businessProductsContainer');

        if (!ownerId) {
            container.innerHTML = '<div class="hint">Cannot load products: Business Owner ID is missing.</div>';
            return;
        }

        try {
            // **Key Fix**: Fetch products using the stable ownerId (deviceId)
            // Note: Assuming the Apps Script backend supports fetching by deviceId for action=list
            const resp = await fetch(`${SCRIPT_URL}?action=list&deviceId=${ownerId}&callback=dummy`);
            const text = await resp.text();
            
            let productsData = null;
            const jsonMatch = text.match(/\(([\s\S]*)\)/);
            
            if (jsonMatch) {
                productsData = JSON.parse(jsonMatch[1]);
            }

            const products = productsData?.rows || [];

            if (products.length === 0) {
                container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
                    No products found for <strong>${targetBusiness}</strong>.
                </div>`;
            } else {
                // **Separation of Concerns**: Only pass data to the rendering function.
                window.renderProductsToDOM(products);
            }

        } catch (e) {
            console.error("Error loading product data by ID:", e);
            container.innerHTML = '<div class="hint">Failed to load products due to a network error.</div>';
        }
    }
    
    function updateSubscribeButton() {
        if (isFollowing) {
            subscribeBtn.textContent = "Following";
            subscribeBtn.className = "unfollow";
        } else {
            subscribeBtn.textContent = "Subscribe";
            subscribeBtn.className = "follow";
        }
        subscribeBtn.disabled = !businessOwnerId || window.IS_ADMIN_VIEW;
    }

    subscribeBtn.addEventListener('click', async () => {
        if (subscribeBtn.disabled || !businessOwnerId) return;

        subscribeBtn.disabled = true;
        subscribeBtn.textContent = "Processing...";

        const action = isFollowing ? "unfollowBusiness" : "followBusiness";
        const payload = { action, followerId: MY_DEVICE_ID, businessOwnerId };

        try {
            const resp = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await resp.json();

            if (result.result === "success") {
                isFollowing = !isFollowing;
                // Re-fetch profile to get updated subscriber count
                const p = await (await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`)).json();
                if (p.data) subscriberCountEl.textContent = `${p.data.subscribers || 0} follower${p.data.subscribers !== 1 ? 's' : ''}`;
                updateSubscribeButton();
            } else {
                alert("Action failed: " + (result.message || "Try again"));
                subscribeBtn.disabled = false;
            }
        } catch (err) {
            alert("Network error");
            subscribeBtn.disabled = false;
        }
    });

    function getBusinessName(p) {
        return (p.businessName || p["Business Name"] || p.BusinessName || p.businessname || "").trim();
    }

    // This function is kept separate to handle DOM manipulation (Separation of Concerns)
    window.renderProductsToDOM = function(products) {
        const container = document.getElementById('businessProductsContainer');
        container.innerHTML = '';

        // NOTE: The name-based filtering below is removed because the fetch is now ID-based.
        // The backend should return only the products for the given businessOwnerId.
        
        const filtered = products; // Already filtered by the backend via ownerId
        
        if (filtered.length === 0) {
            container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
                No products found for <strong>${targetBusiness}</strong>.
            </div>`;
            return;
        }

        const cats = [...new Set(filtered.map(p => p.category || 'General').filter(Boolean))];
        document.getElementById('businessCategories').textContent = cats.join(' • ');

        const byCategory = {};
        filtered.forEach(p => {
            const cat = p.category || 'General';
            if (!byCategory[cat]) byCategory[cat] = [];
            byCategory[cat].push(p);
        });

        for (const [category, items] of Object.entries(byCategory)) {
            const header = document.createElement('h4');
            header.className = 'category-group-header-small';
            header.textContent = category;
            container.appendChild(header);

            const row = document.createElement('div');
            row.className = 'product-group-wrapper';

            items.forEach(p => {
                if (!p.rowId && p.row) p.rowId = p.row;
                const card = createProductCard(p); // Assuming createProductCard is a global function
                row.appendChild(card);
            });

            container.appendChild(row);
        }
    };

        // Sharing functions - NOW POINTS TO business.html
    function generateShareableLink(businessName) {
        if (!businessName?.trim()) return '';
        const encodedName = encodeURIComponent(businessName.trim());
        // Forces the link to open business.html (works everywhere: WhatsApp, Telegram, etc.)
        return `https://vibe-ultrafiles04.github.io/Uchumi-Chat/business.html?name=${encodedName}`;
    }

    function copyLinkToClipboard() {
        const link = document.getElementById('shareLinkInput').value;
        const button = document.getElementById('copyShareLinkBtn');
        navigator.clipboard.writeText(link).then(() => {
            button.textContent = "Copied!";
            setTimeout(() => button.textContent = "Copy Link", 2000);
        }).catch(() => alert("Copy failed"));
    }

    function setupSharing() {
        const shareWrapper = document.getElementById('shareWrapper');
        if (!targetBusiness) {
            shareWrapper.style.display = 'none';
            return;
        }
        shareWrapper.style.display = 'block';

        const link = generateShareableLink(targetBusiness);
        document.getElementById('shareLinkInput').value = link;

        // Proper event attachment without breaking listener
        const copyBtn = document.getElementById('copyShareLinkBtn');
        copyBtn.onclick = copyLinkToClipboard;
    }
    
    /**
     * C. Updated initBusinessPage:
     * Implements the strict, unified flow.
     * REMOVED: Redundant calls.
     */
    async function initBusinessPage() {
        setupSharing();
        if (!targetBusiness) return;

        // 1. Determine the correct ownerId first (NO PRODUCT FETCH HERE)
        const ownerId = await determineOwnerId();
        
        // 2. Load the Profile/Description/Video using the determined ID (NO PRODUCT FETCH HERE)
        await loadProfileData(ownerId);

        // 3. Load and render products using the determined ID (Single source of product fetch)
        await loadAndDisplayProducts(ownerId); 
    }

    // Init
    initBusinessPage();

    // D. Removed Redundancy:
    // REMOVED: loadBusinessData() is completely removed as its responsibilities are split between loadProfileData and loadAndDisplayProducts.
</script>
</body>
</html>