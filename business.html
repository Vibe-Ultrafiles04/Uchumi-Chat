<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Products</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin: 0; padding: 0 0 80px; background: #f9f9f9; font-family: "Segoe UI", Roboto, Arial, sans-serif; overflow-x: hidden; }
        body { animation: slideInFromRight 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards; }
        body.page-exit { animation: slideOutToLeft 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards; }
        @keyframes slideInFromRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutToLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }

        .back-btn {
            position: fixed; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0,0,0,0.8); color: white; border: none;
            padding: 12px 18px; border-radius: 50px; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: #000; }

        .business-header {
            text-align: center; padding: 80px 20px 50px;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('') center/cover no-repeat;
            color: white; margin-bottom: 30px;
        }
        .business-header h1 { font-size: 2.8rem; margin: 0 0 8px 0; }
        .business-header .categories { font-size: 1.2rem; opacity: 0.9; margin-bottom: 12px; }

        .business-description {
            font-size: 1.15rem; line-height: 1.6; max-width: 800px;
            margin: 15px auto 25px; opacity: 0.95; font-weight: 300; padding: 0 20px;
        }
        @media (max-width: 768px) { .business-description { font-size: 1rem; } }

        .subscribe-section {
            margin: 20px auto; display: flex; align-items: center; justify-content: center;
            gap: 15px; flex-wrap: wrap;
        }
        .subscribe-count { font-size: 1.1rem; opacity: 0.9; }
        .subscribe-btn {
            background: #ff4081; color: white; border: none; padding: 10px 24px;
            border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,64,129,0.4);
        }
        .subscribe-btn:hover { background: #f50057; transform: translateY(-2px); }
        .subscribe-btn.subscribed { background: #4caf50; box-shadow: 0 4px 15px rgba(76,175,80,0.4); }
        .subscribe-btn.subscribed:hover { background: #388e3c; }

        #businessProductsContainer {
            display: flex; flex-direction: column; gap: 20px;
            padding: 0 10px; margin: 0 auto; max-width: 1400px;
        }
    </style>
</head>
<body>

    <button class="back-btn" onclick="goBackSmooth()">Back</button>

    <div class="business-header">
        <h1 id="businessName">Loading...</h1>
        <div class="categories" id="businessCategories"></div>
        <p class="business-description" id="businessDescription">Loading description...</p>

        <div class="subscribe-section">
            <span class="subscribe-count" id="subscriberCount">Loading...</span>
            <button class="subscribe-btn" id="subscribeBtn">Subscribe</button>
        </div>
    </div>

    <div id="businessProductsContainer">
        <div class="hint">Loading products...</div>
    </div>

    <div id="productsContainer" style="display:none;"></div>

    <script>
        window.IS_ADMIN_VIEW = false;
    </script>
    <script src="index.js"></script>

    <script>
        // YOUR REAL WEB APP URL (same as in setup.html)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkltpi2s6oMtq2FTfvF3taqCsBTC2RMmxeJ35bhYljOsBCmiKvjifOMwv4ggougm9Wcw/exec";

        // Same device ID logic as setup.html
        function getDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', id);
            }
            return id;
        }
        const visitorDeviceId = getDeviceId();

        function goBackSmooth() {
            document.body.classList.add('page-exit');
            setTimeout(() => window.history.back(), 100);
        }

        const params = new URLSearchParams(location.search);
        const targetBusiness = decodeURIComponent(params.get('name') || '').trim();

        if (!targetBusiness) {
            document.getElementById('businessName').textContent = 'Invalid Link';
            document.getElementById('businessProductsContainer').innerHTML = '<div class="hint">No business specified</div>';
        } else {
            document.getElementById('businessName').textContent = targetBusiness;
        }

        let businessOwnerDeviceId = null;

        // Load business info: description + subscribers + follow state
        async function loadBusinessInfo() {
            try {
                // Step 1: Get any product to grab the owner's deviceId
                const listResp = await fetch(`${SCRIPT_URL}?action=list&business=${encodeURIComponent(targetBusiness)}&callback=dummy`);
                const text = await listResp.text();
                const jsonMatch = text.match(/\(([\s\S]*)\)/);
                if (!jsonMatch) throw new Error("Invalid response");
                const data = JSON.parse(jsonMatch[1]);

                if (!data.rows || data.rows.length === 0) {
                    document.getElementById('businessDescription').textContent = "No description available.";
                    document.getElementById('subscriberCount').textContent = "0 followers";
                    document.getElementById('subscribeBtn').style.display = 'none';
                    return;
                }

                businessOwnerDeviceId = data.rows[0].businessOwnerId;

                // Step 2: Get the actual profile
                const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerDeviceId}`);
                const profile = await profileResp.json();

                if (profile.result === "success" && profile.data) {
                    const desc = profile.data.businessDescription?.trim();
                    document.getElementById('businessDescription').textContent = desc || "This business hasn’t added a description yet.";

                    const count = profile.data.subscribers || 0;
                    document.getElementById('subscriberCount').textContent = 
                        `${count.toLocaleString()} ${count === 1 ? 'follower' : 'followers'}`;

                    // Prevent self-subscribe
                    if (visitorDeviceId === businessOwnerDeviceId) {
                        document.getElementById('subscribeBtn').style.display = 'none';
                        return;
                    }

                    // Check if already following
                    const subscribedTo = profile.data.subscribedTo || [];
                    const isFollowing = subscribedTo.includes(visitorDeviceId);

                    const btn = document.getElementById('subscribeBtn');
                    btn.textContent = isFollowing ? "Unsubscribe" : "Subscribe";
                    btn.classList.toggle('subscribed', isFollowing);
                }
            } catch (err) {
                console.error("Load failed:", err);
                document.getElementById('businessDescription').textContent = "Description unavailable.";
            }
        }

        // Subscribe / Unsubscribe
        document.getElementById('subscribeBtn').addEventListener('click', async () => {
    if (!businessOwnerDeviceId || visitorDeviceId === businessOwnerDeviceId) return;

    const btn = document.getElementById('subscribeBtn');
    const isUnsub = btn.textContent === "Unsubscribe";
    btn.disabled = true;
    btn.textContent = "Loading...";

    try {
        await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
                action: isUnsub ? "unfollowBusiness" : "followBusiness",
                followerId: visitorDeviceId,
                businessOwnerId: businessOwnerDeviceId
            })
        });

        await loadBusinessInfo();  // This refreshes count + button state
    } catch (e) {
        alert("Subscription failed. Try again.");
        btn.disabled = false;
        btn.textContent = isUnsub ? "Unsubscribe" : "Subscribe";
    }
});

        // Your existing product rendering (unchanged)
        function getBusinessName(p) {
            return (p.businessName || p["Business Name"] || p.BusinessName || p.businessname || "").trim();
        }

        window.renderProductsToDOM = function(products) {
            const container = document.getElementById('businessProductsContainer');
            container.innerHTML = '';

            const filtered = products.filter(p => getBusinessName(p) === targetBusiness);
            if (filtered.length === 0) {
                container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
                    No products found for <strong>${targetBusiness}</strong>
                </div>`;
                return;
            }

            const cats = [...new Set(filtered.map(p => p.category || 'General').filter(Boolean))];
            document.getElementById('businessCategories').textContent = cats.join(' • ');

            const byCategory = {};
            filtered.forEach(p => {
                const cat = p.category || 'General';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(p);
            });

            for (const [category, items] of Object.entries(byCategory)) {
                const header = document.createElement('h4');
                header.className = 'category-group-header-small';
                header.textContent = category;
                container.appendChild(header);

                const row = document.createElement('div');
                row.className = 'product-group-wrapper';
                items.forEach(p => {
                    if (!p.rowId && p.row) p.rowId = p.row;
                    const card = createProductCard(p);
                    row.appendChild(card);
                });
                container.appendChild(row);
            }
        };

        // Start
        if (targetBusiness) loadBusinessInfo();
        fetchAndRenderProducts();
    </script>
</body>
</html>