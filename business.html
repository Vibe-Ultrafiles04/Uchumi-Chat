<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Products</title>
    <link rel="stylesheet" href="style.css">

    <style>
        body { 
            margin: 0; 
            padding: 0 0 80px; 
            background: #f9f9f9; 
            font-family: "Segoe UI", Roboto, Arial, sans-serif; 
            overflow-x: hidden;
        }

        /* ====== SMOOTH PAGE TRANSITIONS ====== */
        body {
            animation: slideInFromRight 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        body.page-exit {
            animation: slideOutToLeft 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to   { transform: translateX(-100%); opacity: 0; }
        }

        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: #000; }

        .business-header {
            text-align: center;
            padding: 80px 20px 40px;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('') center/cover no-repeat;
            color: white;
            margin-bottom: 30px;
        }
        .business-header h1 { font-size: 2.8rem; margin: 0 0 10px 0; }
        .business-header .categories { font-size: 1.2rem; opacity: 0.9; }

        /* Description styling */
        .business-description {
            font-size: 1.15rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 20px auto 0;
            opacity: 0.95;
            font-weight: 300;
            padding: 0 20px;
        }
        @media (max-width: 768px) {
            .business-description { font-size: 1rem; padding: 0 15px; }
        }

        /* === SUBSCRIBE BUTTON STYLES === */
        .subscribe-wrapper {
            margin: 25px auto 0;
            text-align: center;
            max-width: 800px;
        }
        #subscribeBtn {
            padding: 14px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }
        #subscribeBtn.follow { background: #4285f4; color: white; }
        #subscribeBtn.follow:hover { background: #3367d6; }
        #subscribeBtn.unfollow { background: #eee; color: #333; }
        #subscribeBtn.unfollow:hover { background: #ddd; }
        #subscribeBtn:disabled { opacity: 0.6; cursor: not-allowed; }

        #subscriberCount {
            margin-top: 10px;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        #businessProductsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
            margin: 0 auto;
            max-width: 1400px;
        }
    </style>
</head>
<body>

    <button class="back-btn" onclick="goBackSmooth()">Back</button>

    <div class="business-header">
        <h1 id="businessName">Loading...</h1>
        <div class="categories" id="businessCategories"></div>
        <p class="business-description" id="businessDescription">Loading description...</p>

        <!-- Subscribe Button + Count -->
        <div class="subscribe-wrapper">
            <button id="subscribeBtn" class="follow" disabled>Loading...</button>
            <div id="subscriberCount">— followers</div>
        </div>
    </div>

    <div id="businessProductsContainer">
        <div class="hint">Loading products...</div>
    </div>

    <!-- Dummy container for index.js -->
    <div id="productsContainer" style="display:none;"></div>

    <script>
        window.IS_ADMIN_VIEW = false;
    </script>
    <script src="index.js"></script>

    <script>
        // CHANGE THIS TO YOUR REAL WEB APP URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqR8gf-VZTYmiw43sB_HnP4neZn1C7g-TJmkkJQb2cykIgV72wxJbISNSTPi8y5Aj6/exec";

        // === DEVICE ID (Persistent across visits) ===
        function getMyDeviceId() {
            let id = localStorage.getItem('myDeviceId');
            if (!id) {
                id = 'guest_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                localStorage.setItem('myDeviceId', id);
            }
            return id;
        }
        const MY_DEVICE_ID = getMyDeviceId();

        // Global state
        let businessOwnerId = null;
        let isFollowing = false;

        // DOM Elements
        const subscribeBtn = document.getElementById('subscribeBtn');
        const subscriberCountEl = document.getElementById('subscriberCount');

        // === BACK BUTTON: Smooth slide back ===
        function goBackSmooth() {
            document.body.classList.add('page-exit');
            setTimeout(() => window.history.back(), 100);
        }

        // Extract business name
        const params = new URLSearchParams(location.search);
        const targetBusiness = decodeURIComponent(params.get('name') || '').trim();

        if (!targetBusiness) {
            document.getElementById('businessName').textContent = 'Invalid Link';
            document.getElementById('businessProductsContainer').innerHTML = '<div class="hint">No business specified</div>';
        } else {
            document.getElementById('businessName').textContent = targetBusiness;
        }

        // === LOAD BUSINESS DESCRIPTION + SUBSCRIBE STATE ===
        async function loadBusinessData() {
            if (!targetBusiness) return;

            try {
                // 1. Get one product to extract owner ID
                const resp = await fetch(`${SCRIPT_URL}?action=list&business=${encodeURIComponent(targetBusiness)}&callback=dummy`);
                const text = await resp.text();
                const jsonMatch = text.match(/\(([\s\S]*)\)/);
                if (!jsonMatch) throw new Error("Invalid response");
                const data = JSON.parse(jsonMatch[1]);

                if (!data.rows || data.rows.length === 0) {
                    document.getElementById('businessDescription').textContent = "No products yet.";
                    subscribeBtn.disabled = true;
                    subscribeBtn.textContent = "No products";
                    return;
                }

                businessOwnerId = data.rows[0].businessOwnerId;
                if (!businessOwnerId) {
                    subscribeBtn.textContent = "Not subscribable";
                    subscribeBtn.disabled = true;
                    return;
                }

                // Prevent self-subscribe
                if (MY_DEVICE_ID === businessOwnerId) {
                    subscribeBtn.textContent = "This is your business";
                    subscribeBtn.disabled = true;
                    subscribeBtn.className = "";
                    return;
                }

                // 2. Load owner's profile (description + subscriber count)
                const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`);
                const profileJson = await profileResp.json();

                if (profileJson.result === "success" && profileJson.data) {
                    const desc = profileJson.data.businessDescription?.trim();
                    document.getElementById('businessDescription').textContent = desc || "This business hasn’t added a description yet.";
                    subscriberCountEl.textContent = `${profileJson.data.subscribers || 0} follower${profileJson.data.subscribers !== 1 ? 's' : ''}`;
                }

                // 3. Check if I am following
                const myResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${MY_DEVICE_ID}`);
                const myJson = await myResp.json();

                if (myJson.result === "success" && myJson.data?.subscribedTo) {
                    isFollowing = myJson.data.subscribedTo.includes(businessOwnerId);
                } else {
                    isFollowing = false;
                }

                updateSubscribeButton();

            } catch (e) {
                console.error(e);
                document.getElementById('businessDescription').textContent = "Failed to load business info.";
            }
        }

        function updateSubscribeButton() {
            if (isFollowing) {
                subscribeBtn.textContent = "Following";
                subscribeBtn.className = "unfollow";
            } else {
                subscribeBtn.textContent = "Subscribe";
                subscribeBtn.className = "follow";
            }
            subscribeBtn.disabled = false;
        }

        // === SUBSCRIBE / UNSUBSCRIBE HANDLER ===
        subscribeBtn.addEventListener('click', async () => {
            if (subscribeBtn.disabled || !businessOwnerId) return;

            subscribeBtn.disabled = true;
            subscribeBtn.textContent = "Processing...";

            const action = isFollowing ? "unfollowBusiness" : "followBusiness";
            const payload = {
                action: action,
                followerId: MY_DEVICE_ID,
                businessOwnerId: businessOwnerId
            };

            try {
                const resp = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();

                if (result.result === "success") {
                    isFollowing = !isFollowing;

                    // Refresh subscriber count
                    const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`);
                    const p = await profileResp.json();
                    if (p.data) {
                        subscriberCountEl.textContent = `${p.data.subscribers || 0} follower${p.data.subscribers !== 1 ? 's' : ''}`;
                    }

                    updateSubscribeButton();
                } else {
                    alert("Action failed: " + (result.message || "Try again"));
                    subscribeBtn.disabled = false;
                    subscribeBtn.textContent = isFollowing ? "Following" : "Subscribe";
                }
            } catch (err) {
                console.error(err);
                alert("Network error. Please try again.");
                subscribeBtn.disabled = false;
                subscribeBtn.textContent = isFollowing ? "Following" : "Subscribe";
            }
        });

        // === ORIGINAL DESCRIPTION LOADER (kept untouched) ===
        async function loadBusinessDescription(businessName) {
            try {
                const listResp = await fetch(`${SCRIPT_URL}?action=list&business=${encodeURIComponent(businessName)}&callback=dummy`);
                const text = await listResp.text();
                const json = text.match(/\(([\s\S]*)\)/)[1];
                const data = JSON.parse(json);

                if (!data.rows || data.rows.length === 0) {
                    document.getElementById('businessDescription').textContent = "No description available.";
                    return;
                }

                const deviceId = data.rows[0].businessOwnerId;
                if (!deviceId) {
                    document.getElementById('businessDescription').textContent = "Description not set yet.";
                    return;
                }

                const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${deviceId}`);
                const profile = await profileResp.json();

                if (profile.result === "success" && profile.data?.businessDescription?.trim()) {
                    document.getElementById('businessDescription').textContent = profile.data.businessDescription.trim();
                } else {
                    document.getElementById('businessDescription').textContent = "This business hasn’t added a description yet.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('businessDescription').textContent = "Description unavailable.";
            }
        }

        // === PRODUCT RENDERING (100% unchanged) ===
        function getBusinessName(p) {
            return (p.businessName || p["Business Name"] || p.BusinessName || p.businessname || "").trim();
        }

        window.renderProductsToDOM = function(products) {
            const container = document.getElementById('businessProductsContainer');
            container.innerHTML = '';

            const filtered = products.filter(p => getBusinessName(p) === targetBusiness);
            if (filtered.length === 0) {
                container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
                    No products found for <strong>${targetBusiness}</strong>
                </div>`;
                return;
            }

            const cats = [...new Set(filtered.map(p => p.category || 'General').filter(Boolean))];
            document.getElementById('businessCategories').textContent = cats.join(' • ');

            const byCategory = {};
            filtered.forEach(p => {
                const cat = p.category || 'General';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(p);
            });

            for (const [category, items] of Object.entries(byCategory)) {
                const header = document.createElement('h4');
                header.className = 'category-group-header-small';
                header.textContent = category;
                container.appendChild(header);

                const row = document.createElement('div');
                row.className = 'product-group-wrapper';

                items.forEach(p => {
                    if (!p.rowId && p.row) p.rowId = p.row;
                    const card = createProductCard(p);
                    row.appendChild(card);
                });

                container.appendChild(row);
            }
        };

        // === INITIALIZE ===
        if (targetBusiness) {
            loadBusinessDescription(targetBusiness);
            loadBusinessData();  // This loads description + subscribe state
        }

        // Keep original product fetch
        fetchAndRenderProducts();
    </script>
</body>
</html>