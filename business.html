<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Products | Kona-Mart</title>

<link rel="stylesheet" href="style.css">

<meta name="theme-color" content="#3b6dc6">
<link rel="manifest" href="./manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="inventory192.png">

<meta property="og:title" content="Kona Mart| Discover Local Business Products">

<meta property="og:url" content="https://vibe-ultrafiles04.github.io/Kona-Mart/business.html">

<meta property="og:description" content="Discover my products and services instantly on Kona Mart.">


<meta property="og:image" content="https://raw.githubusercontent.com/Vibe-Ultrafiles04/Uchumi-Chat/main/Kona100.png">


<meta property="og:type" content="website">



<meta name="twitter:card" content="summary_large_image">

<meta name="twitter:image" content="https://raw.githubusercontent.com/Vibe-Ultrafiles04/Uchumi-Chat/main/Kona100.png">

    <style>
        body { 
            margin: 0; 
            padding: 0 0 80px; 
            background: #f9f9f9; 
            font-family: "Segoe UI", Roboto, Arial, sans-serif; 
            overflow-x: hidden;
        }

        /* ====== SMOOTH PAGE TRANSITIONS ====== */
        body {
            animation: slideInFromRight 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        body.page-exit {
            animation: slideOutToLeft 0.5s cubic-bezier(0.32, 0.72, 0, 1) forwards;
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to   { transform: translateX(-100%); opacity: 0; }
        }

        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: #000; }

        .business-header {
            text-align: center;
            padding: 80px 20px 40px;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('') center/cover no-repeat;
            color: white;
            margin-bottom: 30px;
        }
        .business-header h1 { font-size: 2.8rem; margin: 0 0 10px 0; }
        .business-header .categories { font-size: 1.2rem; opacity: 0.9; }

        .business-description {
            font-size: 1.15rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 20px auto 0;
            opacity: 0.95;
            font-weight: 300;
            padding: 0 20px;
        }
        @media (max-width: 768px) {
            .business-description { font-size: 1rem; padding: 0 15px; }
        }

        .subscribe-wrapper {
            margin: 25px auto 0;
            text-align: center;
            max-width: 800px;
        }
        #subscribeBtn {
            padding: 14px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }
        #subscribeBtn.follow { background: #4285f4; color: white; }
        #subscribeBtn.follow:hover { background: #3367d6; }
        #subscribeBtn.unfollow { background: #eee; color: #333; }
        #subscribeBtn.unfollow:hover { background: #ddd; }
        #subscribeBtn:disabled { opacity: 0.6; cursor: not-allowed; }

        #subscriberCount {
            margin-top: 10px;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        /* PROMOTIONAL VIDEO SECTION */
        .video-section {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s ease-out forwards;
        }
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: #000;
            cursor: pointer;
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .video-info {
            text-align: center;
            margin-top: 12px;
            color: #555;
            font-size: 0.95rem;
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        #businessProductsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 10px;
            margin: 0 auto;
            max-width: 1400px;
        }

        /* Add basic styling for the QR Code section */
        #qrcode canvas, #qrcode img {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #downloadQrBtn:disabled, #printQrBtn:disabled, #generateQrBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #generateQrBtn:hover:not(:disabled) { background: #1e7e34; }
        #downloadQrBtn:hover:not(:disabled) { background: #e0a800; }
        #printQrBtn:hover:not(:disabled) { background: #138496; }
    /* ====== STICKY PAGE VIEWS CSS ====== */
/* ====== STICKY PAGE VIEWS WITH SLIDING ANIMATION ====== */
#videoSection {
    position: relative;
}

#videoViews {
    position: sticky;
    top: 10px;
    left: 10px;
    z-index: 100;
    display: inline-flex; /* Changed to inline-flex to fit background to text */
    align-items: center;
    background: rgba(0, 0, 0, 0.75);
    color: #ffffff;
    padding: 4px 12px; /* Tighter padding to prevent it from being too long */
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    margin-left: 15px;
    pointer-events: none;
    overflow: hidden; 
    width: auto; /* Ensures background only covers the content */
}

/* The actual sliding number container */
.view-count-number {
    display: inline-block;
    margin-left: 5px;
}

/* Animation trigger class - Slowed down to 0.8s */
.digit-slide-up {
    animation: slideUpDigit 0.8s cubic-bezier(0.25, 1, 0.5, 1);
}

@keyframes slideUpDigit {
    0% { transform: translateY(100%); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

.video-info {
    text-align: left;
    margin-top: -42px; /* Adjusted slightly for the tighter padding */
    position: relative;
    z-index: 101;
}
/* Floating Cart Button */
   #floatingCartBtn {
    position: fixed;
    top: 80px;           /* Places it below the header/back button */
    right: 20px;
    background: #ea4335;
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-size: 24px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}
    #floatingCartBtn:hover { transform: scale(1.1); }
    #cartCount {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff1744;
        color: white;
        font-size: 12px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    /* Modal Overlay */
    .order-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
        display: none;
    }
    .order-modal {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        position: relative;
    }
    .order-modal-header {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #eee;
        font-size: 1.4rem;
        font-weight: bold;
        color: #333;
    }
    .order-modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
    }
    .order-modal-body {
        padding: 20px;
    }
    .cart-items-list {
        margin-bottom: 20px;
    }
    .cart-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    .cart-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 12px;
    }
    .cart-item-info {
        flex-grow: 1;
    }
    .cart-item-name {
        font-weight: bold;
        font-size: 1rem;
    }
    .cart-item-price {
        color: #ea4335;
        font-weight: bold;
    }
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .quantity-controls button {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
    }
    .quantity-controls input {
        width: 50px;
        text-align: center;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    .remove-item {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
    }

    .order-total {
        font-size: 1.3rem;
        font-weight: bold;
        text-align: right;
        margin: 20px 0;
        color: #ea4335;
    }

    .customer-form label {
        display: block;
        margin: 15px 0 5px;
        font-weight: bold;
    }
    .customer-form input, .customer-form textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 12px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .customer-form textarea {
        height: 100px;
        resize: vertical;
    }

    .order-actions {
        display: flex;
        gap: 12px;
        margin-top: 25px;
    }
    .order-actions button {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
    }
    .btn-cancel-order { background: #ddd; color: #333; }
    .btn-place-order { background: #28a745; color: white; }

    .empty-cart-message {
        text-align: center;
        padding: 40px;
        color: #888;
        font-size: 1.2rem;
    }
    .cart-stock.out-of-stock { color: #dc3545; font-weight: bold; }
.cart-stock.low-stock { color: #e67e22; font-weight: bold; }

.order-tracking-card {
    max-width: 600px;
    margin: 40px auto;
    padding: 25px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    text-align: left;
}

.order-item {
    background: #f9f9f9;
    border-radius: 16px;
    padding: 18px;
    margin-bottom: 16px;
    border-left: 5px solid #ea4335;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.order-id {
    font-weight: bold;
    color: #ea4335;
    font-size: 1.1rem;
}

.order-date {
    font-size: 0.9rem;
    color: #666;
}

.order-status {
    padding: 6px 14px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 0.85rem;
}

.status-Pending { background: #fff3cd; color: #856404; }
.status-Confirmed { background: #d1ecf1; color: #0c5460; }
.status-Delivered { background: #d4edda; color: #155724; }
.status-Cancelled { background: #f8d7da; color: #721c24; }

.order-items-list {
    margin: 12px 0;
    padding-left: 10px;
    border-left: 2px solid #eee;
}

.order-item-line {
    display: flex;
    justify-content: space-between;
    margin: 6px 0;
    font-size: 0.95rem;
}

.order-total {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: right;
    margin-top: 12px;
    color: #ea4335;
}
/* Big bold customer name at the top (exactly like seller notifications) */
.customer-name {
    font-size: 1.4rem;
    font-weight: bold;
    color: #333;
    margin: 12px 0 8px 0;
    text-align: left;
}

/* Delivery location line ‚Äî same style as other meta info */
.order-meta {
    font-size: 0.95rem;
    color: #666;
    margin: 8px 0;
    padding-left: 2px;
}

/* Customer note box ‚Äî highlighted but still clean */
.message-content {
    background: #f8f9fa;
    border-left: 4px solid #ea4335;
    padding: 12px 14px;
    border-radius: 8px;
    margin: 14px 0;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #333;
}

.message-content strong {
    color: #ea4335;
    font-size: 1rem;
    display: block;
    margin-bottom: 6px;
}

/* Slight spacing adjustment for better flow */
.order-items-list {
    margin: 14px 0;
    padding-left: 10px;
    border-left: 2px solid #eee;
}
    </style>
</head>
<body>

    <button class="back-btn" onclick="goBackSmooth()">Back</button>

    <div class="business-header">
        <h1 id="businessName">Loading...</h1>
        <div class="categories" id="businessCategories"></div>
        <p class="business-description" id="businessDescription">Loading description...</p>

        <div class="subscribe-wrapper">
            <button id="subscribeBtn" class="follow" disabled>Loading...</button>
            <div id="subscriberCount">‚Äî </div>
        </div>
        
        

        <div class="share-wrapper" id="shareWrapper" style="margin-top: 30px; padding: 0 20px;">
            <p id="shareLabel" style="font-size: 1rem; margin-bottom: 10px; opacity: 0.9;">
                Share this business page:
            </p>
            <div style="display: flex; gap: 10px; max-width: 600px; margin: auto;">
                <input type="text" id="shareLinkInput" readonly 
                       style="flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 0.95rem; background: #fff;">
                <button id="copyShareLinkBtn" 
                        style="padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Copy Link
                </button>
            </div>
        </div>
    </div>
<div class="share-wrapper" id="shareWrapper" style="margin-top: 30px; padding: 0 20px;">
            <p id="shareLabel" style="font-size: 1rem; margin-bottom: 10px; opacity: 0.9;">
                Share this business page:
            </p>
            
            
            <button id="toggleQrBtn" onclick="toggleQrCodeSection()"
                    style="margin-top: 15px; padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Show QR Generator
            </button>
        </div>
    </div>
    
    <div class="qr-code-wrapper" id="qrCodeSectionWrapper" style="display: none; margin-top: 30px; padding: 0 20px;">
        <p id="qrLabel" style="font-size: 1rem; margin-bottom: 10px; opacity: 0.9;">
            Generate and Download QR Code:
        </p>
    
        <div class="qr-inputs-container" style="max-width: 600px; margin: auto; display: flex; flex-direction: column; gap: 10px;">
            <input type="text" id="qrNameInput" placeholder="Enter Business Name (e.g., Kona-Mart)"
                        style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 0.95rem; background: #fff;">
            <textarea id="qrDescriptionInput" placeholder="Enter Description (e.g., Fresh groceries daily)"
                        rows="2" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 0.95rem; background: #fff; resize: vertical;"></textarea>
            
            <button id="generateQrBtn" 
                        style="padding: 12px 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                Generate QR Code
            </button>
        </div>
    
        <div id="qrcode" style="margin: 20px auto; width: 256px; height: 256px;">
        </div>
    
        <div class="qr-actions" id="qrActions" style="max-width: 300px; margin: 10px auto 0; display: flex; gap: 10px; justify-content: center;">
            <button id="downloadQrBtn" disabled
                        style="padding: 10px 15px; background: #ffc107; color: #333; border: none; border-radius: 8px; cursor: pointer;">
                Download
            </button>
            <button id="printQrBtn" disabled
                        style="padding: 10px 15px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Print
            </button>
        </div>
    </div>
<!-- My Orders Tracking Card - Collapsible -->
<div class="order-tracking-card" id="orderTrackingCard">
    <!-- Toggle Button -->
    <button id="toggleOrdersBtn" style="
        width: 100%;
        padding: 16px;
        background: #ea4335;
        color: white;
        border: none;
        border-radius: 16px 16px 0 0;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 0;
    ">
        <span>My Orders</span>
        <span id="toggleArrow" style="font-size: 1.4rem; transition: transform 0.3s ease;">‚ñº</span>
    </button>

    <!-- Collapsible Content -->
    <div id="ordersContent" style="
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        border-radius: 0 0 20px 20px;
    ">
        <div style="padding: 25px;">
            <div id="recoveryKeySection">
                <p style="text-align:center; margin-bottom:15px; color:#666;">
                    Enter your Order Recovery Key to view your orders and status.
                </p>
                <input type="text" id="recoveryKeyInput" placeholder="e.g. AB3K9P2M" maxlength="8"
                       style="width:100%; padding:14px; margin-bottom:12px; border-radius:12px; border:1px solid #ccc; box-sizing:border-box; text-transform:uppercase; text-align:center; font-size:1.2rem; letter-spacing:2px;">
                <button id="viewOrdersBtn"
                        style="width:100%; padding:14px; background:#ea4335; color:white; border:none; border-radius:50px; font-weight:bold; cursor:pointer;">
                    View My Orders
                </button>
                <p style="font-size:0.9rem; margin-top:15px; color:#888; text-align:center;">
                    You received this key after placing an order.<br>
                    It lets you check status anytime.
                </p>
            </div>

            <div id="ordersSection" style="display:none;">
                <div id="ordersList"></div>
                <button id="logoutOrdersBtn"
                        style="width:100%; margin-top:20px; padding:12px; background:#f0f0f0; color:#333; border:1px solid #ddd; border-radius:50px;">
                    Log Out / Use Different Key
                </button>
            </div>

            <div id="noOrdersMsg" style="display:none; text-align:center; padding:40px; color:#888;">
                <p>No orders found with this key.</p>
                <p style="font-size:0.9rem;">Make sure you're using the correct recovery key.</p>
            </div>
        </div>
    </div>
</div>
    
    <!-- PROMOTIONAL VIDEO (appears only if set) -->
    <div class="video-section" id="videoSection" style="display:none;">
        <div class="video-wrapper" id="videoWrapper">
            <iframe id="promoVideo" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe>
        </div>
      <div class="video-info">
    <div id="videoViews">
        <span>Page Views:</span>
        <span id="viewNumber" class="view-count-number">0</span>
    </div>
</div>

    <div id="businessProductsContainer">
        <div class="hint">Loading products...</div>
    </div>

    <div id="productsContainer" style="display:none;"></div>
    <!-- Floating Cart Button -->
<button id="floatingCartBtn" style="display:flex !important;">
    üõí
    <span id="cartCount">0</span>
</button>

<!-- Order Modal Overlay -->
<div class="order-modal-overlay" id="orderModalOverlay">
    <div class="order-modal">
        <div class="order-modal-header">
            Your Order
            <button class="order-modal-close" onclick="closeOrderModal()">√ó</button>
        </div>
        <div class="order-modal-body">
            <div id="cartItemsList" class="cart-items-list"></div>
            <div id="emptyCartMessage" class="empty-cart-message">
                Your cart is empty. Add products to place an order.
            </div>
            <div class="order-total" id="orderTotal">Total: KES 0</div>

            <div class="customer-form">
                <label for="customerName">Your Name *</label>
                <input type="text" id="customerName" required placeholder="Enter your name">

                <label for="customerLocation">Delivery Location / Address *</label>
                <input type="text" id="customerLocation" required placeholder="e.g., Westlands, Nairobi">

                <label for="orderMessage">Message to Seller (Optional)</label>
                <textarea id="orderMessage" placeholder="Any special instructions?"></textarea>
            </div>

            <div class="order-actions">
                <button class="btn-cancel-order" onclick="closeOrderModal()">Cancel</button>
                <button class="btn-place-order" onclick="placeOrder()">Place Order</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============== RECOVERY KEY AUTO-SAVE & AUTO-FILL ==============

const RECOVERY_KEY_STORAGE = 'konaMartRecoveryKey';

// Function to save the key
function saveRecoveryKey(key) {
    if (key && /^[A-Z0-9]{8}$/.test(key.trim().toUpperCase())) {
        localStorage.setItem(RECOVERY_KEY_STORAGE, key.trim().toUpperCase());
    }
}

// Function to load and autofill the key on page load
function loadSavedRecoveryKey() {
    const savedKey = localStorage.getItem(RECOVERY_KEY_STORAGE);
    if (savedKey && recoveryKeyInput) {
        recoveryKeyInput.value = savedKey;
        // Optional: Auto-expand the card so user sees it's already filled
        // expandOrdersCard(); // Uncomment if you want card open by default when key exists
    }
}

// Auto-fill when page loads
document.addEventListener('DOMContentLoaded', loadSavedRecoveryKey);

// Save the key immediately after a successful order
// (We modify the placeOrder success block)
</script>
<script>
// === COLLAPSIBLE MY ORDERS CARD - WITH AUTO-LOAD ON OPEN ===
const toggleOrdersBtn = document.getElementById('toggleOrdersBtn');
const ordersContent = document.getElementById('ordersContent');
const toggleArrow = document.getElementById('toggleArrow');

toggleOrdersBtn.addEventListener('click', function() {
    if (ordersContent.style.maxHeight && ordersContent.style.maxHeight !== '0px') {
        // Collapse
        ordersContent.style.maxHeight = '0px';
        toggleArrow.textContent = '‚ñº';
    } else {
        // Expand
        ordersContent.style.maxHeight = ordersContent.scrollHeight + 100 + 'px';
        toggleArrow.textContent = '‚ñ≤';

        // AUTO-LOAD ORDERS IF KEY IS SAVED AND ORDERS NOT YET VISIBLE
        const savedKey = localStorage.getItem('konaMartRecoveryKey');
        if (savedKey && ordersSection.style.display === 'none') {
            recoveryKeyInput.value = savedKey;
            viewOrdersBtn.click(); // This automatically loads the orders
        }
    }
});

// Helper functions (keep these if not already present)
function expandOrdersCard() {
    ordersContent.style.maxHeight = ordersContent.scrollHeight + 100 + 'px';
    toggleArrow.textContent = '‚ñ≤';
}

function refreshOrdersHeight() {
    if (ordersContent.style.maxHeight !== '0px') {
        ordersContent.style.maxHeight = ordersContent.scrollHeight + 100 + 'px';
    }
}
</script>
<script>
// ============== CART + ONE RECOVERY KEY UNLOCKS ALL CUSTOMER ORDERS ==============

let cart = [];

// DOM Elements
const floatingCartBtn = document.getElementById('floatingCartBtn');
const cartCountEl = document.getElementById('cartCount');
const orderModalOverlay = document.getElementById('orderModalOverlay');
const cartItemsList = document.getElementById('cartItemsList');
const emptyCartMessage = document.getElementById('emptyCartMessage');
const orderTotalEl = document.getElementById('orderTotal');

const recoveryKeyInput = document.getElementById('recoveryKeyInput');
const viewOrdersBtn = document.getElementById('viewOrdersBtn');
const recoveryKeySection = document.getElementById('recoveryKeySection');
const ordersSection = document.getElementById('ordersSection');
const ordersList = document.getElementById('ordersList');
const noOrdersMsg = document.getElementById('noOrdersMsg');
const logoutOrdersBtn = document.getElementById('logoutOrdersBtn');

// Success message
const successMessage = document.createElement('div');
successMessage.style.cssText = `
    background: #d4edda; color: #155724; padding: 16px; border-radius: 12px;
    margin: 20px auto; max-width: 600px; text-align: center; font-weight: bold;
    border: 1px solid #c3e6cb; display: none;
`;
successMessage.id = 'orderSuccessMessage';
// Place success message inside the collapsible content (so it's hidden when card is closed)
const contentPaddingDiv = document.querySelector('#ordersContent > div');
contentPaddingDiv.insertBefore(successMessage, recoveryKeySection);

// Cart UI functions (unchanged)
function updateCartUI() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCountEl.textContent = totalItems;
    renderCartItems();
    updateOrderTotal();
}

function renderCartItems() {
    if (cart.length === 0) {
        cartItemsList.innerHTML = '';
        emptyCartMessage.style.display = 'block';
        return;
    }
    emptyCartMessage.style.display = 'none';

    cartItemsList.innerHTML = cart.map((item, index) => {
        const p = item.product;
        const thumbUrl = (typeof getThumbnailUrl === 'function' ? getThumbnailUrl(p.driveLink || '', 200) : '') || '';
        const price = parseFloat(p.sell || 0);
        const stock = parseInt(p.quantity || 0);

        const stockText = stock === 0 ? 'Out of stock' :
                          stock <= 5 ? `Only ${stock} left!` : `${stock} in stock`;
        const stockClass = stock === 0 ? 'out-of-stock' : stock <= 5 ? 'low-stock' : '';

        return `
            <div class="cart-item">
                ${thumbUrl ? `<img src="${thumbUrl}" alt="${escapeHtml(p.name)}">` : '<div style="width:60px;height:60px;background:#eee;border-radius:8px;margin-right:12px;"></div>'}
                <div class="cart-item-info">
                    <div class="cart-item-name">${escapeHtml(p.name || 'Product')}</div>
                    <div class="cart-item-price">KES ${typeof formatNumberWithCommas === 'function' ? formatNumberWithCommas(price) : price}</div>
                    <div class="cart-stock ${stockClass}" style="font-size:0.85rem; margin-top:4px;">${stockText}</div>
                </div>
                <div class="quantity-controls">
                    <button ${item.quantity <= 1 || stock === 0 ? 'disabled' : ''} onclick="changeQuantity(${index}, -1)">‚àí</button>
                    <input type="number" value="${item.quantity}" min="1" readonly>
                    <button ${item.quantity >= stock || stock === 0 ? 'disabled' : ''} onclick="changeQuantity(${index}, 1)">+</button>
                </div>
                <button class="remove-item" onclick="removeFromCart(${index})">Remove</button>
            </div>
        `;
    }).join('');
}

function updateOrderTotal() {
    const total = cart.reduce((sum, item) => sum + (parseFloat(item.product.sell || 0) * item.quantity), 0);
    orderTotalEl.textContent = `Total: KES ${typeof formatNumberWithCommas === 'function' ? formatNumberWithCommas(total) : total}`;
}

function addToCart(productData) {
    const stock = parseInt(productData.quantity || 0);
    if (stock === 0) {
        alert(`Sorry, "${productData.name}" is out of stock.`);
        return;
    }
    const existing = cart.find(item => item.product.rowId === productData.rowId || (item.product.id && item.product.id === productData.id));
    const btn = event?.target;
    if (existing) {
        if (existing.quantity >= stock) {
            alert(`Only ${stock} available.`);
            return;
        }
        existing.quantity += 1;
        if (btn) btn.textContent = 'Increased!';
    } else {
        cart.push({ product: productData, quantity: 1 });
        if (btn) btn.textContent = 'Added!';
    }
    if (btn) {
        btn.style.background = '#28a745';
        setTimeout(() => {
            btn.textContent = 'Add to Cart';
            btn.style.background = '#ea4335';
        }, 1000);
    }
    updateCartUI();
}

window.changeQuantity = function(index, change) {
    const item = cart[index];
    const stock = parseInt(item.product.quantity || 0);
    const newQty = item.quantity + change;
    if (newQty < 1) {
        if (confirm("Remove this item?")) cart.splice(index, 1);
    } else if (newQty > stock) {
        alert(`Only ${stock} available.`);
    } else {
        item.quantity = newQty;
    }
    updateCartUI();
};

window.removeFromCart = function(index) {
    if (confirm("Remove from cart?")) {
        cart.splice(index, 1);
        updateCartUI();
    }
};

floatingCartBtn.onclick = () => {
    orderModalOverlay.style.display = 'flex';
    renderCartItems();
    updateOrderTotal();
};

window.closeOrderModal = () => {
    orderModalOverlay.style.display = 'none';
};

orderModalOverlay.onclick = (e) => {
    if (e.target === orderModalOverlay) closeOrderModal();
};

// ============== PLACE ORDER ‚Äî GET KEY + LOAD ALL ORDERS ==============
window.placeOrder = async function() {
    if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
    }

    const customerName = document.getElementById('customerName').value.trim();
    const customerLocation = document.getElementById('customerLocation').value.trim();

    if (!customerName || !customerLocation) {
        alert("Please enter your name and location.");
        return;
    }

    const items = cart.map(item => ({
        name: item.product.name || "Unknown Product",
        price: parseFloat(item.product.sell || 0),
        quantity: item.quantity
    }));

    const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);

    const payload = {
        action: "placeOrder",
        businessOwnerId: businessOwnerId,
        customerDeviceId: MY_DEVICE_ID,
        customerName: customerName,
        customerLocation,
        message: document.getElementById('orderMessage').value.trim(),
        items,
        total,
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.result !== "success" || !result.recoveryKey) {
            throw new Error("Order failed");
        }

       const recoveryKey = result.recoveryKey.toUpperCase();

successMessage.innerHTML = `
    Order placed successfully!<br>
    <strong>Recovery Key: ${recoveryKey}</strong><br>
    <small>Saved automatically ‚Äî you can close and come back anytime!</small>
`;
successMessage.style.display = 'block';

// Auto-fill input AND save to localStorage
recoveryKeyInput.value = recoveryKey;
saveRecoveryKey(recoveryKey);  // ‚Üê This saves it permanently for this device

        // Load ALL orders using device ID (one key = all orders)
        await loadAllCustomerOrders();
        expandOrdersCard();
setTimeout(refreshOrdersHeight, 300);
        cart = [];
        updateCartUI();
        closeOrderModal();

        // Keep name for next order
        document.getElementById('customerName').value = customerName;
        document.getElementById('customerLocation').value = '';
        document.getElementById('orderMessage').value = '';

    } catch (err) {
        console.error(err);
        successMessage.innerHTML = "Order sent! Use your key to view it.";
        successMessage.style.display = 'block';
        cart = [];
        updateCartUI();
        closeOrderModal();
    }
};

// ============== ENTER KEY ‚Üí LOAD ALL ORDERS (ONE KEY = ALL) ==============
viewOrdersBtn.onclick = async () => {
    let key = recoveryKeyInput.value.trim().toUpperCase();
    if (!/^[A-Z0-9]{8}$/.test(key)) {
        alert("Please enter a valid 8-character recovery key.");
        return;
    }

    // Show loading state
    ordersList.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Loading your orders...</div>';
    recoveryKeySection.style.display = 'none';
    ordersSection.style.display = 'block';
    noOrdersMsg.style.display = 'none';
    successMessage.style.display = 'none';

    // Expand the card first so user sees what's happening
    expandOrdersCard();

    // Load orders
    await loadAllCustomerOrders();

    // After orders load, refresh height in case content grew
    setTimeout(refreshOrdersHeight, 200);
};
// ============== LOAD ALL ORDERS FOR THIS CUSTOMER (DEVICE-BASED) ==============
async function loadAllCustomerOrders() {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
                action: "getCustomerOrders",
                deviceId: MY_DEVICE_ID
            })
        });

        const result = await response.json();

        if (result.result === "success" && result.orders && result.orders.length > 0) {
            displayOrders(result.orders);
            successMessage.innerHTML = `Found ${result.orders.length} order(s)`;
            successMessage.style.display = 'block';
        } else {
            noOrdersMsg.style.display = 'block';
            ordersList.innerHTML = '';
            successMessage.innerHTML = "No orders found yet.";
            successMessage.style.display = 'block';
        }
    } catch (err) {
        console.error(err);
        ordersList.innerHTML = '<p style="text-align:center;color:#c00;">Failed to load orders. Try again.</p>';
    }
}

// ============== LOG OUT / USE DIFFERENT KEY ==============
logoutOrdersBtn.onclick = () => {
    recoveryKeySection.style.display = 'block';
    ordersSection.style.display = 'none';
    noOrdersMsg.style.display = 'none';
    successMessage.style.display = 'none';
    recoveryKeyInput.value = '';
    ordersList.innerHTML = '';
};

// ============== DISPLAY ORDERS ‚Äî YOUR ORIGINAL CLEAN STYLE + EXACT NAME ==============
function displayOrders(orders) {
    if (orders.length === 0) {
        noOrdersMsg.style.display = 'block';
        ordersList.innerHTML = '';
        return;
    }
    noOrdersMsg.style.display = 'none';

    let html = '';

    const grouped = {};
    orders.forEach(order => {
        const name = order.businessName || "Unknown Shop";
        if (!grouped[name]) grouped[name] = [];
        grouped[name].push(order);
    });

    Object.keys(grouped).sort().forEach(businessName => {
        html += `<h4 style="color:#ea4335; margin:20px 0 10px; text-align:center;">${businessName}</h4>`;

        grouped[businessName].forEach(order => {
            const itemsHtml = (order.items || []).map(i => `
                <div class="order-item-line">
                    <span>${i.quantity} √ó ${i.name}</span>
                    <span>KES ${formatNumberWithCommas(i.quantity * i.price)}</span>
                </div>
            `).join('');

            const statusClass = `status-${order.status || 'Pending'}`;

            const customerNote = order.message ? 
                `<div class="message-content"><strong>Your Note to Seller:</strong>${order.message.replace(/\n/g, '<br>')}</div>` : '';

            html += `
                <div class="order-item">
                    <div class="order-header">
                        <div class="order-status ${statusClass}">${order.status || 'Pending'}</div>
                    </div>
                    <div class="order-date">Placed on: ${order.timestamp || 'Unknown time'}</div>
                    
                    <div class="customer-name">${order.customerName || 'You'}</div>
                    
                    <div class="order-meta">Delivery Location: ${order.customerLocation || 'Not provided'}</div>
                    
                    <div class="order-items-list">${itemsHtml}</div>
                    
                    <div class="order-total">Total: KES ${formatNumberWithCommas(order.total || 0)}</div>
                    
                    ${customerNote}
                </div>
            `;
        });
    });

    ordersList.innerHTML = html;
    expandOrdersCard();
    setTimeout(refreshOrdersHeight, 200);
}
// ==== NUMBER FORMATTING WITH COMMAS (for KES prices) ====
function formatNumberWithCommas(number, decimals = 0) {
    if (number == null || isNaN(number)) return '0';
    
    const num = parseFloat(number);
    const fixed = num.toFixed(decimals);
    const parts = fixed.split('.');
    const whole = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    return decimals > 0 && parts.length > 1 ? whole + '.' + parts[1] : whole;
}
// Add to Cart override (unchanged)
function setupProductCardOverride() {
    if (typeof createProductCard !== 'function') {
        setTimeout(setupProductCardOverride, 100);
        return;
    }
    const original = createProductCard;
    window.createProductCard = function(r) {
        const card = original(r);
        if (!window.IS_ADMIN_VIEW) {
            const info = card.querySelector('.card-info');
            if (info) {
                const stock = parseInt(r.quantity || 0);
                const stockText = stock === 0 ? 'Out of stock' :
                                  stock <= 5 ? `Only ${stock} left` : `${stock} in stock`;
                const stockEl = document.createElement('div');
                stockEl.style.fontSize = '0.9rem';
                stockEl.style.margin = '8px 0';
                stockEl.style.color = stock === 0 ? '#dc3545' : stock <= 5 ? '#e67e22' : '#28a745';
                stockEl.style.fontWeight = 'bold';
                stockEl.textContent = stockText;
                info.appendChild(stockEl);

                const addBtn = document.createElement('button');
                addBtn.className = 'btn-black update-product-btn';
                addBtn.style.marginTop = '10px';
                addBtn.style.background = stock === 0 ? '#999' : '#ea4335';
                addBtn.style.width = '100%';
                addBtn.textContent = stock === 0 ? 'Out of Stock' : 'Add to Cart';
                addBtn.disabled = stock === 0;
                addBtn.onclick = (e) => {
                    e.stopPropagation();
                    const copy = { ...r };
                    if (r.row && !copy.rowId) copy.rowId = r.row;
                    addToCart(copy);
                };
                info.appendChild(addBtn);
            }
        }
        return card;
    };
}
setupProductCardOverride();
updateCartUI();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
   <script>
    window.IS_ADMIN_VIEW = false;
</script>
<script src="index.js"></script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('‚úÖ Kona Mart SW Registered: ', registration.scope);
        })
        .catch(error => {
          console.error('‚ùå Kona Mart SW Registration failed: ', error);
        });
    });
  }
</script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_yNzXeF9S8gVaW7tfCmkjOz_xDHy7uZxLrnSS9oAr2sgeOv_bM40h4w5irrIhmvA0xw/exec";

    function getMyDeviceId() {
        let id = localStorage.getItem('myDeviceId');
        if (!id) {
            id = 'guest_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            localStorage.setItem('myDeviceId', id);
        }
        return id;
    }
    const MY_DEVICE_ID = getMyDeviceId();
   
    
    let businessOwnerId = null;
    let isFollowing = false;
    let currentVideoViews = 0;
    let activeVideoDriveId = null;
    let qrCodeInstance = null;
    let qrCanvasOrImage = null; // Stores the generated QR element

    const subscribeBtn = document.getElementById('subscribeBtn');
    const subscriberCountEl = document.getElementById('subscriberCount');
    const videoSection = document.getElementById('videoSection');
    const videoWrapper = document.getElementById('videoWrapper');
    const promoVideo = document.getElementById('promoVideo');
    const videoViewsEl = document.getElementById('videoViews');
    const businessDescriptionEl = document.getElementById('businessDescription');
    const businessProductsContainer = document.getElementById('businessProductsContainer'); // Ensure this element is referenced
    // QR Code Generation Logic
    const qrNameInput = document.getElementById('qrNameInput');
    const qrDescriptionInput = document.getElementById('qrDescriptionInput');
    const generateQrBtn = document.getElementById('generateQrBtn');
    const qrcodeContainer = document.getElementById('qrcode');
    const downloadQrBtn = document.getElementById('downloadQrBtn');
    const printQrBtn = document.getElementById('printQrBtn');

    function goBackSmooth() {
        document.body.classList.add('page-exit');
        setTimeout(() => window.history.back(), 100);
    }

    const params = new URLSearchParams(location.search);
    const targetBusiness = decodeURIComponent(params.get('name') || '').trim();
    
    if (!targetBusiness) {
        document.getElementById('businessName').textContent = 'Invalid Link';
        businessProductsContainer.innerHTML = '<div class="hint">No business specified</div>';
    } else {
        document.getElementById('businessName').textContent = targetBusiness;
        // Initial loading state for products
        businessProductsContainer.innerHTML = '<div class="loading-spinner">Loading products...</div>'; 
    }

    // ... existing variables and functions (like goBackSmooth, getMyDeviceId, etc.)

// NEW TOGGLE FUNCTION
function toggleQrCodeSection() {
    const qrSection = document.getElementById('qrCodeSectionWrapper');
    const toggleBtn = document.getElementById('toggleQrBtn');

    if (qrSection.style.display === 'none' || !qrSection.style.display) {
        qrSection.style.display = 'block';
        toggleBtn.textContent = 'Hide QR Generator';
        // Optional: Pre-populate inputs when showing the section
        prepopulateQrInputs();
    } else {
        qrSection.style.display = 'none';
        toggleBtn.textContent = 'Show QR Generator';
    }
}
// ... rest of your existing functions (loadProfileData, initBusinessPage, etc.)
    // Extract Google Drive file ID from share link
    function extractDriveId(url) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
    }

    // Format view count nicely
    function formatViews(num) {
    let formatted = num;
    if (num >= 1000000) formatted = (num / 1000000).toFixed(1) + 'M';
    else if (num >= 1000) formatted = (num / 1000).toFixed(1) + 'K';
    return formatted;
}

   // Load video (no view increment here)

  async function loadPromotionalVideo(profileData) {
    if (!profileData?.videoLink) {
        videoSection.style.display = 'none';
        activeVideoDriveId = null; // Clear the active ID if no video is present
        return;
    }

    const driveId = extractDriveId(profileData.videoLink);
    if (!driveId) {
        videoSection.style.display = 'none';
        activeVideoDriveId = null; // Clear the active ID if extraction fails
        return;
    }

    // ‚≠ê Store the unique Drive ID globally
    activeVideoDriveId = driveId;

    promoVideo.src = `https://drive.google.com/file/d/${driveId}/preview`;
    
    // --- UPDATED FOR SLIDE ANIMATION ---
    currentVideoViews = profileData.videoViews || 0;
    const viewNumberEl = document.getElementById('viewNumber');
    
    if (viewNumberEl) {
        viewNumberEl.textContent = formatViews(currentVideoViews);
        // Reset and trigger slide-up on initial load
        viewNumberEl.classList.remove('digit-slide-up');
        void viewNumberEl.offsetWidth; 
        viewNumberEl.classList.add('digit-slide-up');
    }

    videoSection.style.display = 'block';
}
    // Increment view only on first click per device for the CURRENT video
async function countVideoView() {
    if (!businessOwnerId || MY_DEVICE_ID === businessOwnerId) return;

    if (videoSection.style.display === 'none') return;

    const videoId = activeVideoDriveId;
    if (!videoId) return;

    const viewedKey = `videoViewed_${videoId}`;
    if (localStorage.getItem(viewedKey)) return;

    localStorage.setItem(viewedKey, 'true');

    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);

        await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
                action: "incrementVideoView",
                businessOwnerId: businessOwnerId,
                viewerDeviceId: MY_DEVICE_ID
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        // --- SLIDE UP ANIMATION UPDATE ---
        currentVideoViews += 1;
        const viewNumberEl = document.getElementById('viewNumber');
        if (viewNumberEl) {
            viewNumberEl.classList.remove('digit-slide-up'); // Reset animation
            void viewNumberEl.offsetWidth;                  // Force reflow
            viewNumberEl.textContent = formatViews(currentVideoViews); // Set new digit
            viewNumberEl.classList.add('digit-slide-up');    // Trigger slide up
        }

    } catch (err) {
        if (err.name !== 'AbortError') console.warn("Video view count failed:", err);
        
        // Fallback: still show animation locally even if network fails
        currentVideoViews += 1;
        const viewNumberEl = document.getElementById('viewNumber');
        if (viewNumberEl) {
            viewNumberEl.classList.remove('digit-slide-up');
            void viewNumberEl.offsetWidth;
            viewNumberEl.textContent = formatViews(currentVideoViews);
            viewNumberEl.classList.add('digit-slide-up');
        }
    }
}
    // NEW HELPER FUNCTION
    async function findOwnerIdByBusinessName(businessName) {
        try {
            const resp = await fetch(`${SCRIPT_URL}?action=findOwnerByName&name=${encodeURIComponent(businessName)}`);
            const json = await resp.json();
            if (json.result === "success" && json.deviceId) {
                return json.deviceId;
            }
            return null;
        } catch (e) {
            console.error("Error finding owner by name:", e);
            return null;
        }
    }

    /**
     * A. Refactored determineOwnerId:
     */
    async function determineOwnerId() {
        let ownerId = null;

        // 1. Search BusinessProfiles sheet by business name
        ownerId = await findOwnerIdByBusinessName(targetBusiness);
        if (ownerId) {
            console.log(`Owner found by name: ${ownerId}`);
            return ownerId;
        }

        // 2. As last resort, check if the current device (MY_DEVICE_ID) owns this business name
        if (!ownerId) {
            console.log("Owner not found by name. Checking if current device is owner...");
            try {
                const myProfileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${MY_DEVICE_ID}`);
                const myProfileJson = await myProfileResp.json();
                
                const myBusinessName = myProfileJson.data?.businessName?.trim();
                if (myProfileJson.result === "success" && myBusinessName === targetBusiness) {
                    console.log(`Current device (${MY_DEVICE_ID}) owns the business name.`);
                    return MY_DEVICE_ID;
                }
            } catch (e) {
                console.warn("Error checking current device ownership:", e);
            }
        }

        return ownerId; // Will be null if all steps fail
    }

    // NEW FUNCTION TO LOAD PROFILE (Description, Video, Subscribers)
    async function loadProfileData(ownerId) {
        if (!ownerId) {
            businessDescriptionEl.textContent = "No owner ID found for this business.";
            subscribeBtn.disabled = true;
            subscribeBtn.textContent = "Unavailable";
            return;
        }

        businessOwnerId = ownerId; // Set the global ID

        if (MY_DEVICE_ID === businessOwnerId) {
            subscribeBtn.textContent = "This is your business";
            subscribeBtn.disabled = true;
            subscribeBtn.className = "";
            window.IS_ADMIN_VIEW = true; // Set admin view flag
        } else {
            window.IS_ADMIN_VIEW = false;
        }

        // 1. Load Business Profile
        try {
            const profileResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`);
            const profileJson = await profileResp.json();

            if (profileJson.result === "success" && profileJson.data) {
                const desc = profileJson.data.businessDescription?.trim();
                businessDescriptionEl.textContent = desc || "This business hasn‚Äôt added a description yet.";
                subscriberCountEl.textContent = `${profileJson.data.subscribers || 0} Patron${profileJson.data.subscribers !== 1 ? 's' : ''}`;

                loadPromotionalVideo(profileJson.data);
                
                // Automatically count video view on successful load
                if (profileJson.data.videoLink) {
                    countVideoView();
                }

            } else {
                businessDescriptionEl.textContent = "Business profile not found or data error.";
                subscribeBtn.disabled = true;
                subscribeBtn.textContent = "Unavailable";
            }

        } catch (e) {
            console.error("Error loading profile:", e);
            businessDescriptionEl.textContent = "Failed to load business profile info.";
            subscribeBtn.disabled = true;
            subscribeBtn.textContent = "Unavailable";
            return;
        }

        // 2. Load Subscription Status
        try {
            const myResp = await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${MY_DEVICE_ID}`);
            const myJson = await myResp.json();
            isFollowing = myJson.result === "success" && myJson.data?.subscribedTo?.includes(businessOwnerId);
            updateSubscribeButton();
        } catch (e) {
            console.error("Error loading subscription status:", e);
            updateSubscribeButton(); 
        }
    }

    /**
     * B. Load and Display Products: Fetches products using the ownerId.
     */
    async function loadAndDisplayProducts(ownerId) {
        const container = businessProductsContainer;

        // Clear loading spinner
        if (container.innerHTML.includes('loading-spinner')) {
             container.innerHTML = '';
        }

        if (!ownerId) {
            container.innerHTML = '<div class="hint">Cannot load products: Business Owner ID is missing.</div>';
            return;
        }

        try {
            const resp = await fetch(`${SCRIPT_URL}?action=list&deviceId=${ownerId}&callback=dummy`);
            const text = await resp.text();
            
            let productsData = null;
            const jsonMatch = text.match(/\(([\s\S]*)\)/);
            
            if (jsonMatch) {
                productsData = JSON.parse(jsonMatch[1]);
            }

            const products = productsData?.rows || [];

            if (products.length === 0) {
                container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
                    No products found for <strong>${targetBusiness}</strong>.
                </div>`;
            } else {
                window.renderProductsToDOM(products);
            }

        } catch (e) {
            console.error("Error loading product data by ID:", e);
            container.innerHTML = '<div class="hint">Failed to load products due to a network error.</div>';
        }
    }
    
    function updateSubscribeButton() {
        if (isFollowing) {
            subscribeBtn.textContent = "Following";
            subscribeBtn.className = "unfollow";
        } else {
            subscribeBtn.textContent = "Subscribe";
            subscribeBtn.className = "follow";
        }
        subscribeBtn.disabled = !businessOwnerId || window.IS_ADMIN_VIEW;
    }

    subscribeBtn.addEventListener('click', async () => {
        if (subscribeBtn.disabled || !businessOwnerId) return;

        subscribeBtn.disabled = true;
        subscribeBtn.textContent = "Processing...";

        const action = isFollowing ? "unfollowBusiness" : "followBusiness";
        const payload = { action, followerId: MY_DEVICE_ID, businessOwnerId };

        try {
            const resp = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await resp.json();

            if (result.result === "success") {
                isFollowing = !isFollowing;
                // Re-fetch profile to get updated subscriber count
                const p = await (await fetch(`${SCRIPT_URL}?action=getBusinessProfile&deviceId=${businessOwnerId}`)).json();
                if (p.data) subscriberCountEl.textContent = `${p.data.subscribers || 0} Patron${p.data.subscribers !== 1 ? 's' : ''}`;
                updateSubscribeButton();
            } else {
                alert("Action failed: " + (result.message || "Try again"));
                subscribeBtn.disabled = false;
            }
        } catch (err) {
            alert("Network error");
            subscribeBtn.disabled = false;
        }
    });

    function getBusinessName(p) {
        return (p.businessName || p["Business Name"] || p.BusinessName || p.businessname || "").trim();
    }

// This function is kept separate to handle DOM manipulation (Separation of Concerns)
window.renderProductsToDOM = function(products) {
    const container = businessProductsContainer;

    // Set up smooth fade-in transition only once
    if (!container.dataset.transitionSet) {
        container.style.opacity = '0';
        container.style.transition = 'opacity 0.5s ease';
        container.dataset.transitionSet = 'true';
    }

    // Hide container while rebuilding to prevent any flash of wrong order
    container.style.opacity = '0';
    container.innerHTML = '';

    if (!Array.isArray(products) || products.length === 0) {
        container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
            No products found for <strong>${targetBusiness}</strong>.
        </div>`;
        requestAnimationFrame(() => container.style.opacity = '1');
        return;
    }

    // Client-side filter (safety net)
    const filtered = products.filter(p => {
        const productName = getBusinessName(p).toLowerCase();
        const targetName = targetBusiness.toLowerCase();
        return productName === targetName;
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="hint" style="padding:80px;text-align:center;font-size:1.2rem;">
            No products found for <strong>${targetBusiness}</strong>.
        </div>`;
        requestAnimationFrame(() => container.style.opacity = '1');
        return;
    }

    // NEW: REVERSE ORDER ‚Äî NEWEST PRODUCTS FIRST (smooth, no jump)
    const reversedProducts = filtered.slice().reverse();

    // Update categories
    const cats = [...new Set(reversedProducts.map(p => p.category || 'General').filter(Boolean))];
    const categoriesEl = document.getElementById('businessCategories');
    if (categoriesEl) {
        categoriesEl.textContent = cats.join(' ‚Ä¢ ');
    }

    // Group by category
    const byCategory = {};
    reversedProducts.forEach(p => {
        const cat = p.category || 'General';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(p);
    });

    // Build full structure while hidden
    for (const [category, items] of Object.entries(byCategory)) {
        const header = document.createElement('h4');
        header.className = 'category-group-header-small';
        header.textContent = category;
        container.appendChild(header);

        const row = document.createElement('div');
        row.className = 'product-group-wrapper';

        items.forEach(p => {
            if (!p.rowId && p.row) p.rowId = p.row;
            const card = createProductCard(p);
            row.appendChild(card);
        });

        container.appendChild(row);
    }

    // Smooth fade-in after everything is ready
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            container.style.opacity = '1';
        });
    });
};
    // Sharing functions - NOW POINTS TO business.html
    function generateShareableLink(businessName) {
        if (!businessName?.trim()) return '';
        const encodedName = encodeURIComponent(businessName.trim());
        // Forces the link to open business.html (works everywhere: WhatsApp, Telegram, etc.)
        return `https://vibe-ultrafiles04.github.io/Uchumi-Chat/business.html?name=${encodedName}`;
    }

    function copyLinkToClipboard() {
        const link = document.getElementById('shareLinkInput').value;
        const button = document.getElementById('copyShareLinkBtn');
        navigator.clipboard.writeText(link).then(() => {
            button.textContent = "Copied!";
            setTimeout(() => button.textContent = "Copy Link", 2000);
        }).catch(() => alert("Copy failed"));
    }

    function setupSharing() {
        const shareWrapper = document.getElementById('shareWrapper');
        if (!targetBusiness) {
            shareWrapper.style.display = 'none';
            return;
        }
        shareWrapper.style.display = 'block';

        const link = generateShareableLink(targetBusiness);
        document.getElementById('shareLinkInput').value = link;

        // Proper event attachment without breaking listener
        const copyBtn = document.getElementById('copyShareLinkBtn');
        copyBtn.onclick = copyLinkToClipboard;
    }
    // Pre-populate inputs with current business info if available
    function prepopulateQrInputs() {
        const businessNameEl = document.getElementById('businessName');
        const descEl = document.getElementById('businessDescription');
        if (targetBusiness && businessNameEl.textContent !== 'Loading...') {
            qrNameInput.value = targetBusiness;
        }
        // This is tricky since description loads async, but we can try
        if (descEl.textContent !== 'Loading description...' && descEl.textContent !== 'Business profile not found or data error.') {
             qrDescriptionInput.value = descEl.textContent.substring(0, 100) + '...'; // Limit description length
        }
    }

   function generateQrCode() {
        // Clear previous QR Code
        qrcodeContainer.innerHTML = '';
        qrCanvasOrImage = null;
        downloadQrBtn.disabled = true;
        printQrBtn.disabled = true;

        // We still get the name/description from inputs to use for the file name, 
        // but they are NO LONGER included in the QR code content.
        const name = qrNameInput.value.trim();
        const description = qrDescriptionInput.value.trim();
        
        // **CRITICAL CHANGE:** Get the direct share link.
        // The generateShareableLink function already creates the correct business.html?name=X link.
        const qrContent = generateShareableLink(name || targetBusiness);
        
        // This check is still useful if you want to ensure the link is generated correctly
        if (!qrContent) {
            alert("Could not generate a valid link for the QR Code.");
            return;
        }

        try {
            // Generate QR Code instance with only the link as the text
            qrCodeInstance = new QRCode(qrcodeContainer, {
                text: qrContent, // This is now only the URL
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Wait a moment for the QR code to render, then find the element
            setTimeout(() => {
                qrCanvasOrImage = qrcodeContainer.querySelector('canvas') || qrcodeContainer.querySelector('img');
                if (qrCanvasOrImage) {
                    downloadQrBtn.disabled = false;
                    printQrBtn.disabled = false;
                }
            }, 500);

        } catch (error) {
            console.error("Error generating QR code:", error);
            alert("Failed to generate QR Code. Check console for details.");
        }
    }
    function downloadQrCode() {
        if (!qrCanvasOrImage) return;

        let dataURL;
        if (qrCanvasOrImage.tagName.toLowerCase() === 'canvas') {
            dataURL = qrCanvasOrImage.toDataURL("image/png");
        } else if (qrCanvasOrImage.tagName.toLowerCase() === 'img') {
            dataURL = qrCanvasOrImage.src; // Should be base64 if canvas failed
        }

        if (dataURL) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = `QR_${qrNameInput.value.replace(/\s/g, '_') || 'business'}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("Could not retrieve QR code image data for download.");
        }
    }

    function printQrCode() {
        if (!qrCanvasOrImage) return;

        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Print QR Code</title>');
        printWindow.document.write('<style>@media print { body { text-align: center; } img { max-width: 100%; height: auto; border: 1px solid #ccc; padding: 10px; } }</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h2>${qrNameInput.value || 'Business'} QR Code</h2>`);

        let imageHTML = '';
        if (qrCanvasOrImage.tagName.toLowerCase() === 'canvas') {
            imageHTML = `<img src="${qrCanvasOrImage.toDataURL('image/png')}" alt="QR Code">`;
        } else if (qrCanvasOrImage.tagName.toLowerCase() === 'img') {
            imageHTML = `<img src="${qrCanvasOrImage.src}" alt="QR Code">`;
        }

        printWindow.document.write(imageHTML);
        printWindow.document.write('<p>Scan this code to view the business page.</p>');
        printWindow.document.write('</body></html>');
        printWindow.document.close();

        // Focus and print after content is loaded
        printWindow.onload = function() {
            printWindow.focus();
            printWindow.print();
        };
    }


    // Event Listeners
    generateQrBtn.addEventListener('click', generateQrCode);
    downloadQrBtn.addEventListener('click', downloadQrCode);
    printQrBtn.addEventListener('click', printQrCode);

    // Integrate prepopulation into the init process
    const originalInitBusinessPage = initBusinessPage;
    initBusinessPage = async () => {
        await originalInitBusinessPage();
        prepopulateQrInputs(); // Prepopulate after loading profile data
    };
    /**
     * C. Updated initBusinessPage:
     */
    async function initBusinessPage() {
        setupSharing();
        if (!targetBusiness) return;

        // 1. Determine the correct ownerId first
        const ownerId = await determineOwnerId();
        
        // 2. Load the Profile/Description/Video using the determined ID
        await loadProfileData(ownerId);

        // 3. Load and render products using the determined ID
        await loadAndDisplayProducts(ownerId); 
    }

    // Init
    initBusinessPage();

</script>
</body>
</html>